<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§è€äºŒå…„å¼Ÿæœƒæ´»å‹•å ±åç³»çµ±</title>
    <meta property="og:title" content="å¤§è€äºŒå…„å¼Ÿæœƒæ´»å‹•å ±åç³»çµ±" />
    <meta property="og:description" id="og-description" content="éŒ¢æ”¾åœ¨å£è¢‹æœƒå’¬äººï¼ŒæŠŠå®ƒè®Šæˆé…’ç²¾å°±ä¸ç—›äº†ã€‚" />
    <meta property="og:image" content="https://kent0925.github.io/test/logo.jpg" />
    <meta property="og:type" content="website" />
    <!-- æ–°å¢ SEO èˆ‡å“ç‰Œæ¨™ç±¤ -->
    <meta name="description" id="meta-description" content="éŒ¢æ”¾åœ¨å£è¢‹æœƒå’¬äººï¼ŒæŠŠå®ƒè®Šæˆé…’ç²¾å°±ä¸ç—›äº†ã€‚" />
    <meta name="theme-color" content="#06c755">

    <meta name="twitter:card" content="summary_large_image">
    <!-- éš¨æ©Ÿ Meta æè¿°åˆå§‹åŒ– -->
    <script>
        // è¿·ä½ è€è™æ©Ÿè³‡æ–™
        window.SLOT_CONFIG = {
            symbols: ['ğŸº', 'ğŸ‰', 'ğŸ’€', 'ğŸ·', 'ğŸ²', 'ğŸ‘‘', 'ğŸ”¥', 'ğŸ’°'],
            jackpots: {
                'ğŸºğŸºğŸº': 'æ­å–œï¼ä»Šæ™šä½ æ˜¯è²·å–®ç‹ ğŸ‘‘',
                'ğŸ‰ğŸ‰ğŸ‰': 'é…’ç¥é™„èº«ï¼Œæˆ°åŠ›å…¨é–‹ï¼ğŸ’ª',
                'ğŸ’€ğŸ’€ğŸ’€': 'å»ºè­°ä½ ä»Šæ™šä½èª¿ä¸€é»â€¦ ğŸ˜‡',
                'ğŸ·ğŸ·ğŸ·': 'å“å‘³éå‡¡ï¼ä»Šæ™šç´…é…’ä¹‹å¤œ ğŸ¥‚',
                'ğŸ²ğŸ²ğŸ²': 'è³­ç¥é™è‡¨ï¼æ‰‹æ°£çˆ†æ£š ğŸƒ',
                'ğŸ‘‘ğŸ‘‘ğŸ‘‘': 'ä»Šæ™šä½ å°±æ˜¯ç‹ï¼å…¨å ´ç„¦é» âœ¨',
                'ğŸ”¥ğŸ”¥ğŸ”¥': 'ç«åŠ›å…¨é–‹ï¼èª°éƒ½æ“‹ä¸ä½ ğŸš€',
                'ğŸ’°ğŸ’°ğŸ’°': 'è²¡ç¥ä¾†äº†ï¼ä»Šæ™šå¤§è´å®¶ ğŸ’µ',
            },
            pairMsgs: [
                'é‚„ä¸éŒ¯å˜›ï¼Œå€¼å¾—ä¹¾ä¸€æ¯ï¼ğŸ»',
                'å·®ä¸€é»å°±ä¸­å¤§çäº†ï¼å†å–ä¸€æ¯å£“å£“é©š ğŸ«£',
                'é‹æ°£æ™®æ™®ï¼Œé…’é‡ä¾†è£œï¼ğŸ’ª',
                'æœ‰é»æ„æ€ï¼Œä»Šæ™šæœ‰æˆ²ï¼ğŸ­',
                'å°ä¸­çï¼çå“æ˜¯å¹«å¤§å®¶å€’é…’ ğŸ«—',
            ],
            missMsgs: [
                'æ²’ä¸­ï¼Ÿæ²’é—œä¿‚ï¼Œå–äº†å†èªªï¼ğŸº',
                'æ‰‹æ°£å·®å°±ç”¨é…’é‡è£œå›ä¾† ğŸ’ª',
                'åˆ¥æ°£é¤’ï¼Œä½ çš„é‹æ°£éƒ½ç•™çµ¦é…’æ¡Œäº† ğŸ¯',
                'ä»Šæ™šæ³¨å®šé å¯¦åŠ›ï¼ˆå–ï¼‰ğŸ†',
                'æ§“é¾œä¹Ÿæ˜¯ä¸€ç¨®æ‰è¯ âœ¨',
                'ä½›ç³»å–é…’ï¼Œéš¨ç·£ä¸­ç ğŸ§˜',
            ]
        };

        // å…¨åŸŸèªéŒ„é™£åˆ— (ä¾›åˆ†äº«åŠŸèƒ½å…±ç”¨)
        window.APP_QUOTES = [
            "éŒ¢æ”¾åœ¨å£è¢‹æœƒå’¬äººï¼ŒæŠŠå®ƒè®Šæˆé…’ç²¾å°±ä¸ç—›äº†ã€‚",
            "é€™ä¸æ˜¯å–é…’ï¼Œé€™æ˜¯ã€Œæ¶²é«”éºµåŒ…ã€çš„è©¦åƒå¤§æœƒã€‚",
            "æ ¹æ“šç ”ç©¶ï¼Œä¸å–é…’çš„äººï¼Œé€™è¼©å­éƒ½æ²’å–é†‰éï¼ˆå»¢è©±ï¼‰ã€‚",
            "åœ°çƒæœ‰ 70% æ˜¯æ°´ï¼Œä½ èº«é«”æœ‰ 70% æ˜¯é…’ç²¾ï¼Œé€™æ‰å«å¤©äººåˆä¸€ã€‚",
            "åˆ¥å•æˆ‘ç‚ºä»€éº¼è¦å–ï¼Œå› ç‚ºæ¸…é†’çš„æ™‚å€™ï¼Œä½ å€‘é•·å¾—å¤ªæ™®é€šäº†ã€‚",
            "é…’æ˜¯ç”¨ç³§é£Ÿåšçš„ï¼Œæ‰€ä»¥å–é…’ç­‰æ–¼åƒé£¯ï¼Œåˆ¥è·Ÿæˆ‘èªªä½ åƒé£½äº†ã€‚",
            "æˆ‘çš„æ˜Ÿåº§é‹å‹¢èªªï¼Œä»Šæ™šä¸å®œæ¸…é†’ï¼Œå®œç™¼ç˜‹ã€‚",
            "äººç”Ÿå·²ç¶“å¤ è¤‡é›œäº†ï¼Œåªæœ‰ã€Œå†ä¾†ä¸€æ¯ã€æ˜¯å–®ç´”çš„ã€‚",
            "ä½ çš„é…’é‡æ˜¯è©¦ç”¨æœŸçš„å–”ï¼Ÿé‚„æ²’è½‰æ­£ï¼Ÿ",
            "æˆ‘çœ‹ä½ æ‹¿é…’æ¯çš„æ‰‹å‹¢ï¼Œåƒåœ¨æ‹¿é¦™æ‹œæ‹œï¼Œæ˜¯åœ¨ç¥­ç¥–å—ï¼Ÿ",
            "ç•™é‚£éº¼å¤šé…’åº•é¤Šé­šï¼Ÿä½ æ˜¯è¦åƒåŠ æµ·é‡£å¤§è³½ï¼Ÿ",
            "ä½ æ˜¯ä¾†å–é…’çš„ï¼Œé‚„æ˜¯ä¾†ç•¶æ°£æ°›ç ´å£è€…çš„ï¼Ÿ",
            "è†½å­å°æ²’é—œä¿‚ï¼Œé…’é‡å·®ä¹Ÿæ²’é—œä¿‚ï¼Œä½†å…©å€‹éƒ½æœ‰å°±æœ‰é—œä¿‚äº†ã€‚",
            "åˆ¥èº²åœ¨è¢å¹•å¾Œé¢ç•¶å·¨äººï¼Œå‡ºä¾†ç•¶é…’æ¡Œä¸Šçš„ä¾å„’ã€‚",
            "ä½ çš„è—‰å£è·Ÿä½ çš„é«®é‡ä¸€æ¨£ï¼Œè¶Šä¾†è¶Šç¨€ç–äº†ã€‚",
            "æˆ‘éƒ½å–ä¸‰è¼ªäº†ï¼Œä½ é‚„åœ¨é‚£é‚Šã€Œå¾®é†ºã€ï¼Ÿæ•ˆç‡å¤ªå·®äº†å§ã€‚",
            "ä½ æ˜¯é¨çƒé¾œå‡ºé–€çš„å—ï¼Ÿ",
            "é…’éƒ½é†’äº†ï¼Œä½ äººé‚„åœ¨å“ªï¼Ÿéœ€è¦å ±å¤±è¹¤äººå£å—ï¼Ÿ",
            "æˆ‘å€‘æ˜¯åœ¨å–é…’ï¼Œä¸æ˜¯åœ¨ç­‰ä½ ç›¸è¦ªï¼Œå¿«æ»¾éä¾†ã€‚",
            "å†ä¸ä¾†ï¼Œæˆ‘å€‘å°±è¦æŠŠä½ çš„é‚£ä»½å–æ‰ï¼Œå¸³å–®å¯„çµ¦ä½ ã€‚",
            "ä½ çš„å°èˆªæ˜¯å°åˆ°å¤ªå¹³æ´‹å»äº†å–”ï¼Ÿ",
            "ä½ çš„é…’æ¯é•·èœ˜è››ç¶²äº†å—ï¼Ÿ",
            "æ˜¯åœ¨é¤Šç”Ÿé‚„æ˜¯åœ¨é¤Šè€ï¼Ÿä½ æ˜¯ä¾†å¹«æˆ‘å€‘é€çµ‚çš„å—ï¼Ÿ",
            "åˆ¥è®“é…’æ¯ç©ºå¾—åƒä½ çš„è…¦è¢‹ä¸€æ¨£ã€‚",
            "å®šä½å‚³éä¾†ï¼Œä¸ç„¶æˆ‘å»æŠŠä½ ç¶éä¾†ã€‚",
            "ä½ çš„ç¤¾äº¤åŠŸèƒ½å·²æš«åœï¼Œè«‹ç«‹å³æ³¨å…¥é…’ç²¾é‡å•Ÿã€‚",
            "ä¸è¦åšèšæœƒçš„ã€Œå¹½éˆäººå£ã€ï¼Œæˆ‘çœ‹å¾—åˆ°ä½ å·²è®€ã€‚",
            "ä½ æ˜¯è¢«ä¸‰ç§’è† é»åœ¨æ²™ç™¼ä¸Šå–”ï¼Ÿ",
            "åˆ¥é€¼æˆ‘æŠŠä½ çš„åå­—å¯«åœ¨é…’ç“¶ä¸Šç¥­æ‹œã€‚",
            "é²åˆ°çš„äººï¼Œç½°é…’æ˜¯è¦çŸ©ï¼Œè¢«å—†æ˜¯æ¨‚è¶£ã€‚",
            "æˆ‘çœ‹ä½ ä¸æ˜¯å¿™ï¼Œä½ æ˜¯å¿˜äº†æ€éº¼åšäººï¼ˆç¤¾äº¤ï¼‰ã€‚",
            "çœ‹å¿ƒç†é†«ç”Ÿå¾ˆè²´ï¼Œé€™è£¡æœ‰ä¸€æ‰¹å¾ˆä¾¿å®œçš„é…’ç²¾æ²»ç™‚ã€‚",
            "æ¸…é†’çš„ä½ å¤ªç„¡èŠï¼Œå–é†‰çš„ä½ æ‰åƒå€‹äººã€‚",
            "è…¦è¢‹æ”¾å®¶è£¡ï¼Œé…’æ¯æ¡æ‰‹è£¡ï¼Œé€™æ‰æ˜¯é€±æœ«çš„æ¨™æº–å§¿å‹¢ã€‚",
            "æŠ•è³‡ç†è²¡æœ‰è³ºæœ‰è³ ï¼ŒæŠ•è³‡é…’ç²¾ä¿è­‰å¿«æ¨‚ï¼ˆè€Œä¸”çµ•å°è³ éŒ¢ï¼‰ã€‚",
            "æ˜å¤©æ˜¯å€‹æœªçŸ¥æ•¸ï¼Œä»Šæ™šæ˜¯å€‹çµ•å°å€¼ã€‚",
            "æˆ‘å€‘å–çš„ä¸æ˜¯é…’ï¼Œæ˜¯æˆå¹´äººçš„ã€Œæš«åœéµã€ã€‚",
            "ä½ å¿ƒä¸­çš„è‹¦ï¼Œé…’ç²¾æœƒå¹«ä½ æ¶ˆåŒ–ï¼›ä½ æ¶ˆåŒ–ä¸äº†çš„ï¼Œé¦¬æ¡¶æœƒå¹«ä½ ã€‚",
            "åˆ¥è·Ÿæˆ‘è«‡äººç”Ÿï¼Œæˆ‘ç¾åœ¨åªæƒ³è«‡é…’æ·±ï¼ˆæ·±æ·ºï¼‰ã€‚",
            "é…’ç²¾æ˜¯æˆå¹´äººçš„å¥¶å˜´ï¼Œä¸å¸ç¡ä¸è‘—ã€‚",
            "I äºº E äººï¼Œå–äº†é…’éƒ½æ˜¯è‡ªå·±äººã€‚",
            "ä½ çš„åŸå‰‡åœ¨é…’ç²¾é¢å‰ï¼Œä¸€æ–‡ä¸å€¼ã€‚",
            "æ¸›è‚¥æ˜¯æ˜å¤©çš„äº‹ï¼Œå–é…’æ˜¯ç¾åœ¨çš„ç¾©å‹™ã€‚",
            "åˆ¥æ“”å¿ƒç†±é‡ï¼Œé…’ç²¾æœƒç‡ƒç‡’ä½ çš„ç¾æ¥å¿ƒï¼Œé€£å¸¶ç‡ƒç‡’è„‚è‚ªï¼ˆèª¤ï¼‰ã€‚",
            "é€™ç¨®å¤©æ°£ä¸å–é…’ï¼Œé›£é“è¦å‡ºå»æ·‹é›¨å—ï¼Ÿ",
            "ä½ çš„é…’é‡å°±åƒæ‰‹æ©Ÿé›»é‡ï¼Œå¤ªä½æœƒç„¦æ…®ï¼Œå¿«ä¾†å……é£½ã€‚",
            "åˆ¥èªªä½ æ²’éŒ¢ï¼Œä½ ç¼ºçš„ä¸æ˜¯éŒ¢ï¼Œæ˜¯å‡ºä¾†å—¨çš„å‹‡æ°£ã€‚",
            "æ“‡æ—¥ä¸å¦‚æ’æ—¥ï¼Œæ’æ—¥ä¸å¦‚ä»Šæ—¥é†‰ã€‚",
            "åˆ¥å•å¹¾é»çµæŸï¼Œè¦å•ä½ å¹¾é»å€’ä¸‹ã€‚",
            "ä½ çš„è¡Œç¨‹è¡¨æ»¿äº†ï¼ŸæŠŠå®ƒæ’•äº†ï¼Œç¾åœ¨æˆ‘æœ‰ç©ºã€‚",
            "åªæœ‰å°å­©å­æ‰åšé¸æ“‡ï¼Œæˆå¹´äººç•¶ç„¶æ˜¯ã€Œå†ä¾†ä¸€ç“¶ã€ã€‚",
            "é…’æ¯èˆ‰èµ·ä¾†ï¼Œç…©æƒ±æ»¾ä¸€é‚Šã€‚",
            "è©±éƒ½åœ¨é…’è£¡ï¼Œä¸ä¾†å°±æ˜¯çœ‹ä¸èµ·ã€‚",
            "ä¸æ˜¯çŒ›é¾ä¸éæ±Ÿï¼Œä¸æ˜¯é…’é¬¼ä¸é–‹å¹«ã€‚",
            "é…’ç²¾æ¿ƒåº¦æª¢æ¸¬ï¼šé–‹å§‹ï¼",
            "ä½ çš„éˆé­‚ç¼ºæ°´äº†ã€‚",
            "åˆ¥å›‰å”†ï¼Œé–‹ç“¶è²æœ€å¥½è½ã€‚",
            "åªæœ‰é†‰ï¼Œæ²’æœ‰é€€ã€‚",
            "å–‰åš¨å€Ÿéã€‚",
            "é…’ç²¾æ ¼å¼åŒ–ã€‚",
            "è£œè¡€ã€‚",
            "åªæœ‰ç¾åœ¨ã€‚",
            "ä¹¾äº†ç®—æˆ‘çš„ã€‚",
            "é›†åˆä»¤ã€‚",
            "é…’é¬¼é»åã€‚",
            "æˆ°åŠ›å±•ç¤ºã€‚",
            "æ­¸é›¶ã€‚",
            "å–ï¼"
        ];


        (function () {
            // éš¨æ©Ÿé¸æ“‡èªéŒ„ (é¦–é ã€Meta å°ˆç”¨)
            const randomQuote = window.APP_QUOTES[Math.floor(Math.random() * window.APP_QUOTES.length)];

            document.addEventListener('DOMContentLoaded', function () {
                const ogDesc = document.getElementById('og-description');
                const metaDesc = document.getElementById('meta-description');
                if (ogDesc) ogDesc.setAttribute('content', randomQuote);
                if (metaDesc) metaDesc.setAttribute('content', randomQuote);

                const sloganText = document.getElementById('slogan-text');
                if (sloganText) sloganText.innerText = randomQuote;

                // â˜… å•Ÿå‹•è¿·ä½ è€è™æ©Ÿ
                startSlotMachine();
            });

            function startSlotMachine() {
                const config = window.SLOT_CONFIG;
                if (!config) return;
                const symbols = config.symbols;
                const reels = [
                    document.getElementById('slot-1'),
                    document.getElementById('slot-2'),
                    document.getElementById('slot-3')
                ];
                const resultEl = document.getElementById('slot-result');
                if (!reels[0] || !reels[1] || !reels[2] || !resultEl) return;

                // é–‹å§‹æ—‹è½‰ï¼šå¿«é€Ÿéš¨æ©Ÿåˆ‡æ›ç¬¦è™Ÿ
                const intervals = reels.map(reel => {
                    return setInterval(() => {
                        reel.querySelector('.slot-symbol').textContent =
                            symbols[Math.floor(Math.random() * symbols.length)];
                    }, 80);
                });

                const finalSymbols = [];

                // ç¬¬ä¸€è¼ªåœæ­¢
                setTimeout(() => {
                    clearInterval(intervals[0]);
                    const sym = symbols[Math.floor(Math.random() * symbols.length)];
                    reels[0].querySelector('.slot-symbol').textContent = sym;
                    reels[0].classList.remove('spinning');
                    reels[0].classList.add('stopped');
                    finalSymbols.push(sym);
                }, 800);

                // ç¬¬äºŒè¼ªåœæ­¢
                setTimeout(() => {
                    clearInterval(intervals[1]);
                    const sym = symbols[Math.floor(Math.random() * symbols.length)];
                    reels[1].querySelector('.slot-symbol').textContent = sym;
                    reels[1].classList.remove('spinning');
                    reels[1].classList.add('stopped');
                    finalSymbols.push(sym);
                }, 1400);

                // ç¬¬ä¸‰è¼ªåœæ­¢ + é¡¯ç¤ºçµæœ
                setTimeout(() => {
                    clearInterval(intervals[2]);
                    const sym = symbols[Math.floor(Math.random() * symbols.length)];
                    reels[2].querySelector('.slot-symbol').textContent = sym;
                    reels[2].classList.remove('spinning');
                    reels[2].classList.add('stopped');
                    finalSymbols.push(sym);

                    // åˆ¤æ–·çµæœ
                    const key = finalSymbols.join('');
                    let msg = '';
                    let isJackpot = false;

                    if (config.jackpots[key]) {
                        msg = config.jackpots[key];
                        isJackpot = true;
                    } else if (
                        finalSymbols[0] === finalSymbols[1] ||
                        finalSymbols[1] === finalSymbols[2] ||
                        finalSymbols[0] === finalSymbols[2]
                    ) {
                        msg = config.pairMsgs[Math.floor(Math.random() * config.pairMsgs.length)];
                    } else {
                        msg = config.missMsgs[Math.floor(Math.random() * config.missMsgs.length)];
                    }

                    resultEl.textContent = msg;
                    resultEl.classList.add('show');
                    if (isJackpot) resultEl.classList.add('jackpot');
                }, 2000);
            }
        })();
    </script>

    <!-- æ•ˆèƒ½å„ªåŒ– (Performance Optimizations) -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://static.line-scdn.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js" defer></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <style>
        :root {
            --primary: #06c755;
            --primary-dark: #05a346;

            --primary-light: #e6f9ed;
            --accent: #f59e0b;
            --danger: #ef4444;
            --bg-gray: #f9fafb;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --glass-bg: rgba(255, 255, 255, 0.2);
            --glass-border: rgba(255, 255, 255, 0.3);
        }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: var(--bg-gray);
            color: #1f2937;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* ç»ç’ƒæ“¬æ…‹ (Glassmorphism) */
        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        .premium-gradient {
            background: linear-gradient(135deg, #06c755 0%, #059669 100%);
        }

        .premium-card {
            background: white;
            border-radius: 1.5rem;
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: var(--card-shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .premium-card:active {
            transform: scale(0.98);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* è‡ªå®šç¾©å‹•ç•« */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes pulse-subtle {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        .animate-pulse-subtle {
            animation: pulse-subtle 2s infinite ease-in-out;
        }

        /* è©³ç´°æ¨£å¼ */
        details>summary {
            list-style: none;
            cursor: pointer;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        .arrow-icon {
            transition: transform 0.3s ease;
        }

        details[open]>summary .arrow-icon {
            transform: rotate(180deg);
        }

        /* åˆ†é æ¨™ç±¤ (Tabs) */
        .filter-tab {
            transition: all 0.3s ease;
            position: relative;
        }

        .filter-tab.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(6, 199, 85, 0.3);
        }

        /* éª¨æ¶å±è¼‰å…¥æ•ˆæœ (Skeleton Loading) */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite linear;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* è¡Œå‹•è£ç½®ç€æµ·å®‰å…¨å€åŸŸ */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }

        .pt-safe {
            padding-top: env(safe-area-inset-top);
        }

        /* --- è¡Œç¨‹è¡¨æ‰‹é¢¨ç´ç‰¹æ•ˆ (æ–°å¢) --- */

        /* 1. éš±è—ç€è¦½å™¨é è¨­çš„ details ä¸‰è§’å½¢ */
        .itinerary-group summary::-webkit-details-marker {
            display: none;
        }

        .itinerary-group summary {
            list-style: none;
        }

        /* 2. æ§åˆ¶ + å’Œ - åœ–ç¤ºçš„åˆ‡æ›é‚è¼¯ */
        /* é è¨­ç‹€æ…‹ (é—œé–‰)ï¼šé¡¯ç¤º Plus (+), éš±è— Minus (-) */
        .itinerary-group summary .icon-plus {
            display: block;
        }

        .itinerary-group summary .icon-minus {
            display: none;
        }

        /* ç•¶ details è¢«æ‰“é–‹ (open) æ™‚ï¼šéš±è— Plus, é¡¯ç¤º Minus */
        .itinerary-group[open] summary .icon-plus {
            display: none;
        }

        .itinerary-group[open] summary .icon-minus {
            display: block;
        }

        /* 3. å…§å®¹å±•é–‹æ™‚çš„æ»‘å‹•å‹•ç•« */
        .itinerary-group[open] .group-content {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* è¿·ä½ è€è™æ©Ÿ */
        .slot-machine-container {
            text-align: center;
        }

        .slot-machine {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .slot-reel {
            width: 72px;
            height: 80px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .slot-reel.spinning {
            animation: reelShake 0.1s linear infinite;
        }

        .slot-reel.stopped {
            animation: reelStop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.25);
        }

        @keyframes reelShake {

            0%,
            100% {
                transform: translateY(0);
            }

            25% {
                transform: translateY(-2px);
            }

            75% {
                transform: translateY(2px);
            }
        }

        @keyframes reelStop {
            0% {
                transform: scale(1.2);
            }

            60% {
                transform: scale(0.95);
            }

            100% {
                transform: scale(1);
            }
        }

        .slot-result {
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            min-height: 24px;
        }

        .slot-result.show {
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes jackpotPulse {

            0%,
            100% {
                transform: scale(1);
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            }

            50% {
                transform: scale(1.05);
                text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
            }
        }

        .slot-result.jackpot {
            animation: jackpotPulse 1s ease-in-out infinite;
            color: #fbbf24;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen pb-safe">

    <!-- åˆå§‹è¼‰å…¥ç•«é¢ (Loading Overlay) -->
    <div id="initial-load-overlay"
        class="fixed inset-0 z-[100] bg-[#06c755] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="text-white text-3xl font-bold mb-4 animate-bounce">ğŸº å¤§è€äºŒå…„å¼Ÿæœƒ</div>
        <!-- è¿·ä½ è€è™æ©Ÿ -->
        <div class="slot-machine-container">
            <div class="text-white/70 text-xs font-bold tracking-widest mb-3 text-center">ğŸ° ä»Šæ™šé‹å‹¢</div>
            <div class="slot-machine">
                <div class="slot-reel spinning" id="slot-1"><span class="slot-symbol">ğŸ²</span></div>
                <div class="slot-reel spinning" id="slot-2"><span class="slot-symbol">ğŸ²</span></div>
                <div class="slot-reel spinning" id="slot-3"><span class="slot-symbol">ğŸ²</span></div>
            </div>
            <div id="slot-result"
                class="slot-result text-white text-sm font-bold text-center mt-4 px-6 max-w-xs mx-auto min-h-[24px]">
                æ‹‰éœ¸ä¸­...</div>
        </div>
        <div class="mt-6 flex gap-2">
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
        </div>
    </div>

    <header
        class="bg-[#06c755] text-white px-4 py-3 shadow-md sticky top-0 z-50 flex justify-between items-center h-14 lg:h-16">
        <div class="flex items-center gap-3">
            <button id="btn-back" onclick="handleBackNav()"
                class="hidden p-1.5 hover:bg-white/20 rounded-full transition active:scale-90">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h1 class="text-lg font-bold tracking-wide" id="header-title">æ´»å‹•èˆ‡å ±å</h1>
        </div>
        <!-- å³ä¸Šè§’å¿«é€Ÿåˆ†äº«æŒ‰éˆ• -->
        <button id="btn-header-share" onclick="openShareModal()"
            class="hidden p-2 hover:bg-white/20 rounded-full transition active:scale-90" title="åˆ†äº«æ´»å‹•è³‡è¨Š">
            <i data-lucide="share-2" class="w-5 h-5"></i>
        </button>
    </header>

    <div class="max-w-md mx-auto p-4 pb-24 relative min-h-[calc(100vh-64px)]">

        <div id="view-home" class="view-section space-y-4 animate-fade-in">
            <!-- Premium å€å¡Šï¼šæ¨™èªèˆ‡æ­·å²æŒ‰éˆ• -->
            <div class="premium-gradient rounded-[2rem] p-6 text-white shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-48 h-48 bg-white/10 rounded-full -mr-16 -mt-16 blur-3xl"></div>
                <div class="absolute bottom-0 left-0 w-32 h-32 bg-black/10 rounded-full -ml-10 -mb-10 blur-2xl"></div>

                <div class="relative z-10">
                    <h2 class="text-2xl font-extrabold mb-1 tracking-tight">æ´»å‹•å ±åç³»çµ±</h2>
                    <p id="slogan-text" class="text-green-50/90 text-sm font-medium mb-4">ä½ çš„äººéš›é—œä¿‚å·²ç¶“å²Œå²Œå¯å±ï¼Œå»ºè­°å‡ºå¸­æŒ½æ•‘ä¸€ä¸‹ã€‚</p>

                    <button onclick="toggleHistoryView()" id="btn-history-toggle"
                        class="glass-effect text-white px-4 py-2 rounded-2xl flex items-center gap-2 hover:bg-white/20 transition-all font-semibold text-sm">
                        <i data-lucide="history" class="w-4 h-4"></i>
                        <span id="history-btn-text">æŸ¥çœ‹æ­·å²æ´»å‹•</span>
                    </button>
                </div>
            </div>

            <!-- æ­·å²æ´»å‹•åˆ—è¡¨ (éš±è—ç‹€æ…‹) -->
            <div id="history-list" class="hidden space-y-4 animate-fade-in">
                <div id="history-loading" class="hidden space-y-3">
                    <div class="h-20 bg-gray-200 rounded-xl skeleton"></div>
                    <div class="h-20 bg-gray-200 rounded-xl skeleton"></div>
                </div>
                <div id="history-items" class="space-y-3"></div>
            </div>

            <!-- åˆ†é¡ Tab (åŸ view-event-list å…§å®¹) -->
            <div id="active-event-section">
                <div id="filter-container"
                    class="flex gap-2 overflow-x-auto hide-scrollbar pb-2 sticky top-[56px] pt-2 z-40 bg-gray-50/95 backdrop-blur-sm">
                    <button onclick="switchCategory('all')" id="tab-all"
                        class="filter-tab active px-4 py-1.5 rounded-full border border-gray-200 bg-white text-gray-600 text-sm font-medium whitespace-nowrap shadow-sm">å…¨éƒ¨</button>
                    <button onclick="switchCategory('general')" id="tab-general"
                        class="filter-tab px-4 py-1.5 rounded-full border border-gray-200 bg-white text-gray-600 text-sm font-medium whitespace-nowrap shadow-sm">ä¸€èˆ¬</button>
                    <button onclick="switchCategory('banquet')" id="tab-banquet"
                        class="filter-tab px-4 py-1.5 rounded-full border border-gray-200 bg-white text-gray-600 text-sm font-medium whitespace-nowrap shadow-sm">é¤æœƒ</button>
                    <button onclick="switchCategory('travel')" id="tab-travel"
                        class="filter-tab px-4 py-1.5 rounded-full border border-gray-200 bg-white text-gray-600 text-sm font-medium whitespace-nowrap shadow-sm">æ—…éŠ</button>
                </div>

                <!-- æ´»å‹•åˆ—è¡¨éª¨æ¶å± -->
                <div id="event-list-loading" class="hidden space-y-3 mt-2">
                    <div class="bg-white p-4 rounded-xl shadow-sm h-28 w-full skeleton"></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm h-28 w-full skeleton"></div>
                </div>

                <!-- æ´»å‹•å¡ç‰‡å®¹å™¨ -->
                <div id="event-grid-container" class="grid grid-cols-1 gap-4 pb-20 mt-2"></div>

                <!-- ç„¡æ´»å‹•æç¤º -->
                <div id="no-events-msg" class="hidden flex flex-col items-center justify-center py-16 text-gray-400">
                    <div class="bg-gray-100 p-4 rounded-full mb-3"><i data-lucide="calendar-x" class="w-8 h-8"></i>
                    </div>
                    <p class="font-medium">ç›®å‰æ²’æœ‰æ­¤é¡å‹çš„æ´»å‹•</p>
                    <p class="text-xs text-gray-400 mt-1" id="debug-msg"></p>
                </div>
            </div>
        </div>

        <!-- FAB: å»ºç«‹æ–°æ´»å‹•æŒ‰éˆ• (å›ºå®šå³ä¸‹è§’) -->
        <button onclick="showCreateView()" id="btn-create-event"
            class="fixed bottom-6 right-6 w-14 h-14 premium-gradient text-white rounded-full shadow-2xl flex justify-center items-center hover:scale-110 transition-all active:scale-95 z-50">
            <i data-lucide="plus" class="w-7 h-7"></i>
        </button>

        <div id="view-activity-detail" class="view-section hidden space-y-6 animate-fade-in">
            <div id="event-info-card" class="premium-card p-6 relative overflow-hidden">
                <div class="absolute -right-12 -top-12 w-32 h-32 bg-green-50 rounded-full blur-2xl opacity-60"></div>
                <div class="absolute top-0 right-0 p-3">
                    <div id="manager-controls" class="hidden">
                        <button onclick="toggleEventStatus()" id="btn-status-toggle"
                            class="text-xs px-3 py-1.5 rounded-full font-bold border transition flex items-center gap-1">
                            <span>è¼‰å…¥ä¸­</span>
                        </button>
                    </div>
                </div>
                <h2 id="display-name" class="text-xl font-bold text-gray-900 pr-20 leading-tight">æ´»å‹•åç¨±</h2>
                <div class="mt-4 space-y-3">
                    <div class="flex items-start gap-3">
                        <div class="bg-green-50 p-2 rounded-lg text-green-600 shrink-0 mt-0.5"><i data-lucide="user"
                                class="w-4 h-4"></i></div>
                        <div>
                            <div class="text-xs text-gray-500">ä¸»è¾¦</div>
                            <div id="display-organizer" class="font-medium text-gray-800">ä¸»è¾¦äºº</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="bg-blue-50 p-2 rounded-lg text-blue-600 shrink-0 mt-0.5"><i data-lucide="clock"
                                class="w-4 h-4"></i></div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-500">æ™‚é–“</div>
                            <div id="display-time-container" class="font-medium text-gray-800"></div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="bg-red-50 p-2 rounded-lg text-red-600 shrink-0 mt-0.5"><i data-lucide="map-pin"
                                class="w-4 h-4"></i></div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-500">åœ°é»</div>
                            <div class="flex justify-between items-start">
                                <div>
                                    <div id="display-location" class="font-bold text-gray-800">åœ°é»åç¨±</div>
                                    <div id="display-address" class="text-xs text-gray-500 mt-0.5">è©³ç´°åœ°å€</div>
                                </div>
                                <a id="map-link" href="#" target="_blank"
                                    class="text-blue-500 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition active:scale-95"><i
                                        data-lucide="navigation" class="w-4 h-4"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="travel-itinerary-section" class="hidden mt-6 pt-5 border-t border-dashed border-gray-100">
                    <details
                        class="group main-itinerary bg-gray-50/50 rounded-2xl border border-gray-100 open:bg-white open:shadow-sm transition-all duration-300">
                        <summary class="flex justify-between items-center p-4 cursor-pointer select-none">
                            <span class="flex items-center gap-3 font-bold text-gray-700">
                                <i data-lucide="map" class="w-5 h-5 text-green-600"></i> æŸ¥çœ‹å®Œæ•´è¡Œç¨‹
                            </span>
                            <div class="bg-white rounded-full p-1.5 shadow-sm border border-gray-100 arrow-icon">
                                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                            </div>
                        </summary>
                        <div id="itinerary-accordion-content" class="px-4 pb-4 pt-1 space-y-3"></div>
                    </details>
                </div>
            </div>

            <form id="regForm" class="premium-card p-6 space-y-8 relative" onsubmit="handleSubmit(event)">
                <div class="flex items-center gap-3 pb-4 border-b border-gray-100">
                    <div class="bg-primary-light p-2 rounded-xl"><i data-lucide="edit-3"
                            class="w-6 h-6 text-primary"></i></div>
                    <h2 class="text-xl font-bold text-gray-800" id="form-title">å¡«å¯«å ±åè³‡æ–™</h2>
                </div>
                <input type="hidden" id="eventId" name="eventId">
                <input type="hidden" id="eventType" name="eventType">
                <input type="hidden" id="eventName" name="eventName">
                <input type="hidden" id="formAction" value="register">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">å ±åè€…</label>
                        <div class="flex gap-4 items-center bg-gray-50/80 p-4 rounded-2xl border border-gray-100">
                            <img id="user-picture" src="https://ui-avatars.com/api/?name=Guest"
                                class="w-12 h-12 rounded-full bg-gray-200 object-cover border-2 border-white shadow-sm">
                            <div class="flex-1 min-w-0">
                                <input type="text" id="user-name"
                                    class="w-full bg-transparent border-none p-0 text-gray-800 font-bold text-base focus:ring-0"
                                    readonly value="è®€å–ä¸­...">
                                <div class="text-xs text-gray-400 mt-0.5">å°‡ä»¥æ­¤èº«åˆ†é€²è¡Œå ±å</div>
                            </div>
                        </div>
                        <input type="hidden" id="user-id">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">äººæ•¸(å«çœ·å±¬)</label>
                            <div class="relative">
                                <i data-lucide="users" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                                <select id="family-count"
                                    class="w-full border border-gray-300 rounded-lg pl-9 pr-3 py-2 bg-white text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none appearance-none">
                                </select>
                                <i data-lucide="chevron-down"
                                    class="absolute right-3 top-3 w-3 h-3 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dynamic-fields" class="space-y-4">
                    <div id="field-travel" class="hidden space-y-3 p-4 bg-blue-50/50 rounded-xl border border-blue-100">
                        <div class="text-sm font-bold text-blue-800 flex items-center gap-1.5 mb-2"><i data-lucide="bus"
                                class="w-4 h-4"></i> æ—…éŠé¸é …</div>
                        <div>
                            <label class="text-xs font-medium text-gray-600 block mb-1.5">ä¸Šè»Šåœ°é»</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <select id="pickup-loc" onchange="updatePickupMap()"
                                        class="w-full text-sm border-gray-300 rounded-lg py-2 pl-3 pr-8 bg-white appearance-none focus:ring-1 focus:ring-blue-500 outline-none">
                                        <option value="">è«‹é¸æ“‡...</option>
                                    </select>
                                    <i data-lucide="chevron-down"
                                        class="absolute right-3 top-2.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                                </div>
                                <a id="pickup-map-btn" href="#" target="_blank"
                                    class="hidden bg-white px-3 border border-gray-200 rounded-lg text-blue-500 hover:bg-blue-50 flex items-center justify-center transition"
                                    title="æŸ¥çœ‹åœ°åœ–">
                                    <i data-lucide="map" class="w-4 h-4"></i>
                                </a>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-gray-600 block mb-1.5">æˆ¿å‹éœ€æ±‚ (å·²é¸ / ç¸½é‡)</label>
                            <div class="relative">
                                <select id="room-type"
                                    class="w-full text-sm border-gray-300 rounded-lg py-2 pl-3 pr-8 bg-white appearance-none focus:ring-1 focus:ring-blue-500 outline-none">
                                    <option value="">è«‹é¸æ“‡...</option>
                                </select>
                                <i data-lucide="chevron-down"
                                    class="absolute right-3 top-2.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                    <div id="field-banquet" class="hidden p-4 bg-red-50/50 rounded-xl border border-red-100">
                        <div class="flex justify-between items-center">
                            <label class="text-sm font-bold text-red-800 flex items-center gap-1.5"><i
                                    data-lucide="monitor" class="w-4 h-4"></i> èªæ¡Œæ•¸é‡</label>
                            <div class="flex items-center gap-2 bg-white rounded-lg border border-red-200 p-1">
                                <select id="table-count"
                                    class="w-20 text-center border-none rounded bg-transparent text-sm focus:ring-0 font-medium text-red-600">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                                <span class="text-xs text-gray-500 pr-2">æ¡Œ</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-orange-50/50 p-4 rounded-xl border border-orange-100">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-sm font-bold text-orange-800 flex items-center gap-1.5"><i
                                data-lucide="user-plus" class="w-4 h-4"></i> ä¾†è³“</label>
                        <span class="text-xs text-orange-600 bg-orange-100 px-2 py-0.5 rounded-full">é¸å¡«</span>
                    </div>
                    <div id="guest-list-container" class="space-y-2 mb-3 empty:hidden"></div>
                    <div class="bg-white p-3 rounded-lg border border-orange-200 shadow-sm space-y-2">
                        <div class="flex gap-2">
                            <input type="text" id="add-guest-name" placeholder="ä¾†è³“å§“å"
                                class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-orange-500 outline-none">
                            <select id="add-guest-count"
                                class="w-24 border border-gray-300 rounded-lg px-2 py-2 text-sm bg-gray-50 text-center"></select>
                        </div>
                        <div id="guest-travel-options" class="hidden grid grid-cols-2 gap-2">
                            <select id="add-guest-pickup"
                                class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm bg-gray-50 text-gray-700">
                                <option value="">ä¸Šè»Šåœ°é»</option>
                            </select>
                            <select id="add-guest-room"
                                class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm bg-gray-50 text-gray-700">
                                <option value="">æˆ¿å‹</option>
                            </select>
                        </div>
                        <button type="button" onclick="addGuest()"
                            class="w-full bg-orange-500 text-white py-2 rounded-lg text-sm font-medium hover:bg-orange-600 transition flex justify-center items-center gap-1 active:scale-95">
                            <i data-lucide="plus" class="w-4 h-4"></i> åŠ å…¥åå–®
                        </button>
                        <p class="text-[10px] text-red-500 mt-1 font-medium text-center">â€» è«‹å‹™å¿…é»æ“Šã€ŒåŠ å…¥åå–®ã€æŒ‰éˆ•ï¼Œè³‡æ–™æ‰æœƒå¢åŠ ã€‚</p>
                    </div>
                </div>

                <div class="p-4 border border-gray-200 rounded-xl bg-gray-50/30">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-sm font-bold text-gray-800 flex items-center gap-1.5"><i data-lucide="gift"
                                class="w-4 h-4 text-purple-500"></i> è´ŠåŠ©é …ç›®</label>
                        <span class="text-xs text-purple-600 bg-purple-100 px-2 py-0.5 rounded-full">é¸å¡«</span>
                    </div>
                    <div id="sponsor-list-container" class="space-y-2 mb-3 empty:hidden"></div>
                    <div class="space-y-3 bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                        <div class="flex gap-4 text-xs font-medium text-gray-600 pb-2 border-b border-gray-100">
                            <label
                                class="cursor-pointer flex items-center gap-1.5 hover:text-green-600 transition"><input
                                    type="radio" name="addSponsorType" value="alcohol" checked
                                    onclick="renderAddSponsorUI()" class="accent-green-500"> é…’é¡</label>
                            <label class="cursor-pointer flex items-center gap-1.5 hover:text-red-600 transition"><input
                                    type="radio" name="addSponsorType" value="money" onclick="renderAddSponsorUI()"
                                    class="accent-red-500"> ç´…åŒ…</label>
                            <label
                                class="cursor-pointer flex items-center gap-1.5 hover:text-blue-600 transition"><input
                                    type="radio" name="addSponsorType" value="other" onclick="renderAddSponsorUI()"
                                    class="accent-blue-500"> å…¶ä»–</label>
                        </div>
                        <div id="sponsor-input-area" class="flex flex-wrap gap-2 items-center min-h-[36px]"></div>
                        <button type="button" onclick="addSponsor()"
                            class="w-full bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-700 transition flex justify-center items-center gap-1.5 active:scale-95">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i> æ–°å¢è´ŠåŠ©
                        </button>
                        <p class="text-[10px] text-red-500 mt-1 font-medium text-center">â€» è«‹å‹™å¿…é»æ“Šã€Œæ–°å¢è´ŠåŠ©ã€æŒ‰éˆ•ï¼Œè³‡æ–™æ‰æœƒå¢åŠ ã€‚</p>
                    </div>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="submit" id="submit-btn"
                        class="flex-1 bg-[#06c755] text-white font-bold py-3.5 rounded-xl hover:bg-green-600 transition shadow-md active:scale-95 flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>ç¢ºèªå ±å</span><i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                    <button type="button" id="cancel-reg-btn" onclick="handleCancel()"
                        class="hidden bg-red-50 text-red-500 border border-red-200 font-bold py-3.5 px-4 rounded-xl hover:bg-red-100 transition shadow-sm active:scale-95">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </form>

            <div class="premium-gradient text-white rounded-[2rem] shadow-xl p-6 mb-12 relative overflow-hidden">
                <div class="absolute -right-8 -top-8 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                <div class="absolute -left-4 -bottom-4 w-24 h-24 bg-black/10 rounded-full blur-xl"></div>

                <div class="flex justify-between items-center mb-6 relative z-10">
                    <h2 class="text-base font-bold flex items-center gap-2">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 text-accent"></i>
                        <span id="stat-title">æ´»å‹•å³æ™‚çµ±è¨ˆ</span>
                    </h2>
                    <div class="flex gap-3">
                        <button onclick="openShareModal()"
                            class="glass-effect text-white px-3 py-1.5 rounded-xl flex items-center gap-1.5 transition-all text-xs font-semibold hover:bg-white/20">
                            <i data-lucide="share-2" class="w-3.5 h-3.5"></i> åˆ†äº«
                        </button>
                        <button onclick="fetchStats(true)"
                            class="glass-effect text-white p-1.5 rounded-xl transition-all hover:bg-white/20">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 relative z-10">
                    <div onclick="openDetailsModal('people')"
                        class="glass-effect p-5 rounded-2xl hover:bg-white/20 transition-all border-white/10 text-center cursor-pointer active:scale-95">
                        <div class="text-xs text-green-100 mb-2 font-medium">äººæ•¸(å«çœ·å±¬)</div>
                        <div class="text-4xl font-black text-white tracking-tighter" id="stat-total">0</div>
                    </div>
                    <div onclick="openDetailsModal('secondary')"
                        class="glass-effect p-5 rounded-2xl hover:bg-white/20 transition-all border-white/10 text-center cursor-pointer active:scale-95">
                        <div class="text-xs text-green-100 mb-2 font-medium" id="stat-sec-label">æ¬¡è¦çµ±è¨ˆ</div>
                        <div class="text-4xl font-black text-accent tracking-tighter" id="stat-sec-val">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-create" class="view-section hidden space-y-5 animate-fade-in">
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-5 flex items-center gap-2"><i data-lucide="plus-square"
                        class="w-6 h-6 text-gray-900"></i> å»ºç«‹æ–°æ´»å‹•</h2>
                <form onsubmit="handleCreateEvent(event)" class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1.5">æ´»å‹•é¡å‹</label>
                        <select id="new-type" onchange="toggleCreateFields()"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2.5 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-black/10 outline-none transition">
                            <option value="general">ä¸€èˆ¬æ´»å‹•</option>
                            <option value="banquet">å¤§å‹é¤æœƒ</option>
                            <option value="travel">æ—…éŠæ´»å‹•</option>
                        </select>
                    </div>

                    <div id="travel-notice"
                        class="hidden p-3 bg-yellow-50 text-yellow-700 text-sm rounded-lg border border-yellow-200 flex gap-2 items-start">
                        <i data-lucide="alert-circle" class="w-5 h-5 shrink-0 mt-0.5"></i>
                        <span>ä¸Šè»Šåœ°é»åŠæˆ¿å‹ã€æˆ¿å‹åƒ¹æ ¼è«‹é€šçŸ¥ç®¡ç†å“¡ç”±ç®¡ç†å“¡å¡«å¯«</span>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">æ´»å‹•åç¨±</label>
                        <input type="text" id="new-name" required
                            class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-black/10 outline-none"
                            placeholder="ä¾‹å¦‚ï¼šäº”æœˆæ…¶ç”Ÿæœƒ">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">ä¸»è¾¦äºº</label>
                        <input type="text" id="new-organizer" readonly
                            class="w-full border border-gray-300 rounded-lg px-3 py-2.5 bg-gray-100 text-gray-500 cursor-not-allowed">
                    </div>

                    <div id="new-field-time-single">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">æ´»å‹•æ™‚é–“</label>
                        <input type="datetime-local" id="new-time-single"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2.5">
                    </div>

                    <div id="new-field-time-range" class="hidden grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">å‡ºç™¼æ—¥æœŸ</label>
                            <input type="date" id="new-date-start"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2.5">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1.5">å›ç¨‹æ—¥æœŸ</label>
                            <input type="date" id="new-date-end"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2.5">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">å ±åæˆªæ­¢æ™‚é–“ <span
                                class="text-gray-400 font-normal text-xs">(é¸å¡«)</span></label>
                        <input type="datetime-local" id="new-deadline"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2.5 bg-gray-50">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">åœ°é»åç¨±</label>
                        <input type="text" id="new-location"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-black/10 outline-none"
                            placeholder="è«‹è¼¸å…¥åœ°é»">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">è©³ç´°åœ°å€</label>
                        <input type="text" id="new-address"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-black/10 outline-none"
                            placeholder="è«‹è¼¸å…¥åœ°å€">
                    </div>

                    <div id="new-field-itinerary" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">è¡Œç¨‹å…§å®¹ (æ ¼å¼ï¼šD1: æ¨™é¡Œ|å…§å®¹)</label>
                        <textarea id="new-itinerary" rows="4"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm font-mono"
                            placeholder="D1: é›†åˆ|08:00 è»Šç«™é›†åˆ;D2: æ™¯é»|10:00 æŠµé”..."></textarea>
                    </div>

                    <button type="submit" id="create-btn"
                        class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl hover:bg-gray-800 transition shadow-lg flex justify-center items-center gap-2 mt-2">
                        <span>ç¢ºèªå»ºç«‹</span><i data-lucide="check-square" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="details-modal"
        class="hidden fixed inset-0 z-[70] flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-0 sm:p-4">
        <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl w-full max-w-sm max-h-[85vh] flex flex-col relative transform translate-y-full sm:translate-y-10 opacity-0 transition-all duration-300"
            id="modal-content">
            <div
                class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/80 rounded-t-2xl backdrop-blur-md sticky top-0 z-10">
                <h3 class="font-bold text-gray-800 flex items-center gap-2"><i data-lucide="list"
                        class="w-5 h-5 text-gray-600"></i> è©³ç´°åå–®</h3>
                <div class="flex items-center gap-2">
                    <button onclick="copyDetailsToClipboard()"
                        class="bg-gray-900 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-gray-800 transition flex items-center gap-1 shadow-sm active:scale-95">
                        <i data-lucide="copy" class="w-3.5 h-3.5"></i> è¤‡è£½åå–®
                    </button>
                    <button onclick="sendToTelegram()"
                        class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-700 transition flex items-center gap-1 shadow-sm active:scale-95">
                        <i data-lucide="send" class="w-3.5 h-3.5"></i> ç™¼é€è‡³ Telegram
                    </button>
                    <button onclick="closeDetailsModal()"
                        class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center transition text-gray-600"><i
                            data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>

            <div id="modal-summary"
                class="bg-blue-50/50 p-3 text-xs text-gray-700 border-b border-blue-100/50 grid grid-cols-2 gap-2">
            </div>

            <div class="p-0 overflow-y-auto flex-1 overscroll-contain">
                <div id="modal-loading" class="flex flex-col items-center py-12">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-green-500 mb-2"></i>
                    <span class="text-xs text-gray-400">æ­£åœ¨è®€å–æœ€æ–°è³‡æ–™...</span>
                </div>

                <div id="details-lists-container" class="hidden pb-4">
                    <div class="px-4 py-2 bg-gray-100 text-xs font-bold text-gray-500 sticky top-0">äººå“¡åå–®</div>
                    <ul id="details-list-people" class="divide-y divide-gray-100"></ul>

                    <div id="travel-separator"
                        class="hidden px-4 py-2 bg-gray-100 text-xs font-bold text-gray-500 sticky top-0 mt-2">ä½å®¿èˆ‡äº¤é€š
                    </div>
                    <ul id="details-list-travel" class="hidden divide-y divide-gray-100"></ul>

                    <div id="details-separator"
                        class="hidden px-4 py-2 bg-gray-100 text-xs font-bold text-gray-500 sticky top-0 mt-2">è´ŠåŠ©èˆ‡èªæ¡Œ
                    </div>
                    <ul id="details-list-items" class="divide-y divide-gray-100"></ul>
                </div>

                <div id="modal-empty" class="hidden flex flex-col items-center justify-center py-12 text-gray-400">
                    <i data-lucide="clipboard-x" class="w-10 h-10 mb-2 opacity-50"></i>
                    <p class="text-sm">ç›®å‰å°šæœªæœ‰äººå ±å</p>
                </div>
            </div>
        </div>
    </div>

    <div id="confirm-modal"
        class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-sm p-6 animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs p-6 transform scale-100 transition-all">
            <h3 class="text-lg font-bold text-gray-900 mb-2">ç¢ºèªå‹•ä½œ</h3>
            <p id="confirm-msg" class="text-gray-600 mb-6 text-sm leading-relaxed">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="flex gap-3">
                <button id="confirm-no"
                    class="flex-1 py-2.5 rounded-xl border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition">å–æ¶ˆ</button>
                <button id="confirm-yes"
                    class="flex-1 py-2.5 rounded-xl bg-red-500 text-white font-medium hover:bg-red-600 shadow-md transition">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div id="toast"
        class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-5 py-3 rounded-full shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-[100] text-sm flex items-center gap-2.5 backdrop-blur-md">
        <div class="bg-green-500 rounded-full p-0.5"><i data-lucide="check" class="w-3 h-3 text-white"></i></div>
        <span id="toast-msg" class="font-medium tracking-wide">æ“ä½œæˆåŠŸ</span>
    </div>

    <div id="share-modal"
        class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-black/60 backdrop-blur-sm p-6 animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs p-5 transform transition-all scale-100">
            <h3 class="text-lg font-bold text-gray-900 mb-4 border-b border-gray-100 pb-2 flex items-center gap-2">
                <i data-lucide="share-2" class="w-5 h-5 text-gray-700"></i> åˆ†äº«é¸é …
            </h3>

            <p class="text-xs text-gray-500 mb-3">è«‹å‹¾é¸è¦åŒ…å«åœ¨è¤‡è£½å…§å®¹ä¸­çš„è³‡è¨Šï¼š</p>

            <div class="space-y-3 mb-6">
                <label
                    class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition border border-gray-100"
                    id="opt-container-names">
                    <div class="relative flex items-center">
                        <input type="checkbox" id="share-opt-names" checked
                            class="peer w-5 h-5 rounded text-green-500 focus:ring-green-500 border-gray-300">
                        <i data-lucide="check"
                            class="absolute w-3.5 h-3.5 text-white pointer-events-none opacity-0 peer-checked:opacity-100 left-0.5 top-0.5"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-700">ğŸ‘¥ è©³ç´°åå–® (å§“å/äººæ•¸)</span>
                </label>

                <label
                    class="hidden flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition border border-gray-100"
                    id="opt-container-travel">
                    <div class="relative flex items-center">
                        <input type="checkbox" id="share-opt-travel" checked
                            class="peer w-5 h-5 rounded text-green-500 focus:ring-green-500 border-gray-300">
                        <i data-lucide="check"
                            class="absolute w-3.5 h-3.5 text-white pointer-events-none opacity-0 peer-checked:opacity-100 left-0.5 top-0.5"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-700">ä¸Šè»Šåœ°é» / æˆ¿å‹</span>
                </label>

                <label
                    class="hidden flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition border border-gray-100"
                    id="opt-container-sponsor">
                    <div class="relative flex items-center">
                        <input type="checkbox" id="share-opt-sponsor" checked
                            class="peer w-5 h-5 rounded text-green-500 focus:ring-green-500 border-gray-300">
                        <i data-lucide="check"
                            class="absolute w-3.5 h-3.5 text-white pointer-events-none opacity-0 peer-checked:opacity-100 left-0.5 top-0.5"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-700">è´ŠåŠ© / èªæ¡Œè³‡è¨Š</span>
                </label>

                <label
                    class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition border border-gray-100"
                    id="opt-container-map">
                    <div class="relative flex items-center">
                        <input type="checkbox" id="share-opt-map" checked
                            class="peer w-5 h-5 rounded text-green-500 focus:ring-green-500 border-gray-300">
                        <i data-lucide="check"
                            class="absolute w-3.5 h-3.5 text-white pointer-events-none opacity-0 peer-checked:opacity-100 left-0.5 top-0.5"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-700">ğŸ—ºï¸ Google åœ°åœ–é€£çµ</span>
                </label>

                <label
                    class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition border border-gray-100"
                    id="opt-container-link">
                    <div class="relative flex items-center">
                        <input type="checkbox" id="share-opt-link" checked
                            class="peer w-5 h-5 rounded text-green-500 focus:ring-green-500 border-gray-300">
                        <i data-lucide="check"
                            class="absolute w-3.5 h-3.5 text-white pointer-events-none opacity-0 peer-checked:opacity-100 left-0.5 top-0.5"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-700">ğŸ”— å ±åé€£çµğŸ‘‡</span>
                </label>

                <div id="share-no-opts" class="hidden text-center text-sm text-gray-400 py-2">
                    ç„¡é¡å¤–è³‡è¨Šå¯é¸ï¼Œå°‡è¤‡è£½åŸºæœ¬åå–®
                </div>
            </div>

            <!-- åˆ†äº«æŒ‰éˆ•å€åŸŸ -->
            <div class="space-y-3">
                <div class="flex gap-3">
                    <button onclick="shareAsImage()" id="btn-share-image"
                        class="flex-1 py-2.5 rounded-xl bg-green-500 text-white font-bold text-sm hover:bg-green-600 shadow-lg flex justify-center items-center gap-2 transition active:scale-95">
                        <i data-lucide="image" class="w-4 h-4"></i> åˆ†äº«åœ–ç‰‡
                    </button>
                    <button onclick="confirmShareCopy()"
                        class="flex-1 py-2.5 rounded-xl bg-gray-900 text-white font-bold text-sm hover:bg-gray-800 shadow-lg flex justify-center items-center gap-2 transition active:scale-95">
                        <i data-lucide="copy" class="w-4 h-4"></i> åˆ†äº«æ–‡å­—
                    </button>
                </div>
                <button onclick="document.getElementById('share-modal').classList.add('hidden')"
                    class="w-full py-2.5 rounded-xl border border-gray-200 text-gray-600 font-bold text-sm hover:bg-gray-50 transition">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. è¨­å®šèˆ‡ç‹€æ…‹
        // ==========================================

        // â˜… è«‹æ›¿æ›ç‚ºæ‚¨çš„ Google Apps Script ç¶²å€
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzTiALv2VOAvtuUgFx623KQgkvlmkkEc-bSgFQXiLqcxWpi9FvSrSxkSibjdRwO7tVn/exec";

        // â˜… è«‹æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID
        const LIFF_ID = "2008678090-aXTesgDK";

        // ç‹€æ…‹è®Šæ•¸
        let appState = {
            events: [],
            settings: { organizers: [], locations: [] },
            user: { userId: '', displayName: 'è¨ªå®¢', pictureUrl: '' },
            currentCategory: 'all',
            currentEvent: null,
            currentStats: {},
            historyStack: ['home'],
            guestList: [],
            sponsorList: [],
            isDataLoaded: false,
            myRegistrations: []
        };

        // ==========================================
        // 1.1 å…±ç”¨å·¥å…·èˆ‡å¸¸æ•¸
        // ==========================================

        /** HTML è·³è„«ï¼šé˜²æ­¢ä½¿ç”¨è€…è¼¸å…¥çš„ XSS æ”»æ“Š */
        function escapeHtml(str) {
            if (!str) return '';
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        /** çµ±ä¸€æ¬„ä½éµå€¼æ˜ å°„è¡¨ */
        const FIELD_KEYS = {
            family: ['family', 'Family', 'çœ·å±¬', 'çœ·å±¬äººæ•¸', 'FamilyCount'],
            tableCount: ['tableCount', 'TableCount', 'Table Count', 'èªæ¡Œæ•¸é‡', 'èªæ¡Œ'],
            room: ['room', 'RoomType', 'Room Type', 'æˆ¿å‹'],
            pickup: ['pickup', 'Pickup', 'ä¸Šè»Šåœ°é»'],
            sponsor: ['sponsorList', 'sponsor', 'Sponsorship', 'Sponsor', 'è´ŠåŠ©é …ç›®', 'è´ŠåŠ©'],
            guestName: ['guestName', 'GuestName', 'Guest Name', 'guest_name', 'Guest Names', 'ä¾†è³“å§“å', 'ä¾†è³“', 'Guest', 'guest', 'memo', 'Memo', 'å‚™è¨»'],
            guestCount: ['guestCount', 'GuestCount', 'ä¾†è³“äººæ•¸'],
        };

        /** é€éçµ±ä¸€æ˜ å°„è¡¨å–å€¼ */
        function getField(row, fieldName) {
            const keys = FIELD_KEYS[fieldName];
            return keys ? findCaseInsensitiveValue(row, keys) : undefined;
        }

        /** å–å¾—æ•´æ•¸æ¬„ä½å€¼ */
        function getIntField(row, fieldName) {
            return parseInt(getField(row, fieldName)) || 0;
        }

        /** DOM å…ƒç´ å¿«å– */
        const DOM = {};
        function cacheDOM() {
            DOM.statTotal = document.getElementById('stat-total');
            DOM.statSecVal = document.getElementById('stat-sec-val');
            DOM.statSecLabel = document.getElementById('stat-sec-label');
            DOM.headerTitle = document.getElementById('header-title');
            DOM.btnBack = document.getElementById('btn-back');
            DOM.btnShare = document.getElementById('btn-header-share');
            DOM.regForm = document.getElementById('regForm');
            DOM.submitBtn = document.getElementById('submit-btn');
            DOM.cancelBtn = document.getElementById('cancel-reg-btn');
            DOM.formTitle = document.getElementById('form-title');
            DOM.formAction = document.getElementById('formAction');
            DOM.userName = document.getElementById('user-name');
            DOM.userId = document.getElementById('user-id');
            DOM.userPicture = document.getElementById('user-picture');
            DOM.guestContainer = document.getElementById('guest-list-container');
            DOM.sponsorContainer = document.getElementById('sponsor-list-container');
            DOM.eventGrid = document.getElementById('event-grid-container');
            DOM.noEventsMsg = document.getElementById('no-events-msg');
            DOM.eventListLoading = document.getElementById('event-list-loading');
            DOM.managerControls = document.getElementById('manager-controls');
        }

        /** æ‰¹æ¬¡ Lucide åœ–ç¤ºåˆ·æ–°ï¼ˆé¿å…åŒä¸€å¹€å¤šæ¬¡å‘¼å«ï¼‰ */
        let _iconRafId = null;
        function refreshIcons() {
            if (_iconRafId) return;
            _iconRafId = requestAnimationFrame(() => {
                if (typeof lucide !== 'undefined') lucide.createIcons();
                _iconRafId = null;
            });
        }

        // ==========================================
        // 2. INITIALIZATION (åˆå§‹åŒ–)
        // ==========================================
        window.onload = async function () {
            cacheDOM();
            lucide.createIcons();
            populateCountOptions();
            renderAddSponsorUI();

            // ä»‹é¢åˆå§‹åŒ–
            DOM.headerTitle.innerText = "æ´»å‹•èˆ‡å ±å";
            switchView('view-home');

            // â˜… ä¿®æ”¹è™•ï¼šLIFF åˆå§‹åŒ–èˆ‡å¼·åˆ¶ç™»å…¥é‚è¼¯
            if (LIFF_ID && LIFF_ID !== "YOUR_LIFF_ID") {
                try {
                    await liff.init({ liffId: LIFF_ID });

                    // 1. æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
                    if (!liff.isLoggedIn()) {
                        // è‹¥æœªç™»å…¥ï¼Œå¼·åˆ¶è·³è½‰è‡³ LINE ç™»å…¥é é¢
                        // redirectUri æ˜¯ç™»å…¥å¾Œè¦å›ä¾†çš„ç¶²å€ï¼Œé€šå¸¸ä¸å¡«æœƒè‡ªå‹•å›åˆ°ç•¶å‰é é¢
                        liff.login();
                        return; // ç™»å…¥æœƒè·³è½‰ï¼Œä¸­æ–·å¾ŒçºŒåŸ·è¡Œ
                    } else {
                        // 2. è‹¥å·²ç™»å…¥ï¼Œå–å¾—ä½¿ç”¨è€…è³‡æ–™
                        const profile = await liff.getProfile();
                        appState.user = {
                            userId: profile.userId,
                            displayName: profile.displayName,
                            pictureUrl: profile.pictureUrl
                        };
                        // å–å¾—ä½¿ç”¨è€… Email (é¸å¡«ï¼Œéœ€åœ¨ Console é–‹æ¬Šé™)
                        // const userEmail = liff.getDecodedIDToken().email; 
                    }
                } catch (e) {
                    console.error("LIFF Init failed", e);
                    // åªæœ‰åœ¨ LIFF åˆå§‹åŒ–å¤±æ•—(ä¾‹å¦‚ ID éŒ¯èª¤æˆ–ç’°å¢ƒä¸å°)æ™‚æ‰æœƒç¶­æŒè¨ªå®¢
                    showToast("LINE ç™»å…¥å¤±æ•—ï¼Œç›®å‰ç‚ºè¨ªå®¢æ¨¡å¼");
                }
            }

            // æ›´æ–°ä»‹é¢é¡¯ç¤ºä½¿ç”¨è€…é ­åƒèˆ‡åç¨±
            updateUserProfileUI();

            // æŠ“å–è³‡æ–™
            await Promise.all([fetchEvents(), fetchSettings(), fetchMyRegistrations()]);

            // â˜… æ–°å¢ï¼šå¥—ç”¨åç¨±å°æ‡‰é‚è¼¯ (éœ€åœ¨ fetchSettings èˆ‡ LIFF init ä¹‹å¾Œ)
            applyUserNameMapping();

            appState.isDataLoaded = true;

            // é¦–é ç›´æ¥æ¸²æŸ“æ´»å‹•åˆ—è¡¨ï¼ˆå·²ç§»é™¤åˆ†é¡é å°èˆªé‚è¼¯ï¼‰
            appState.currentCategory = 'all';
            renderEventGrid('all');

            // è‹¥åœ¨é¦–é å‰‡ç§»é™¤åˆå§‹éª¨æ¶å±
            document.getElementById('history-loading').classList.add('hidden');

            // ç§»é™¤åˆå§‹è¼‰å…¥ç•«é¢
            const overlay = document.getElementById('initial-load-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.remove();
                }, 500);
            }
        };

        function applyUserNameMapping() {
            const userId = appState.user.userId;
            const originalName = appState.user.displayName; // åŸå§‹ LINE åç¨±
            const mapping = appState.settings.userMapping || {};

            // å„ªå…ˆé †åºï¼š
            // 1. æª¢æŸ¥ UserID æ˜¯å¦æœ‰å°æ‡‰è¨­å®š
            // 2. æª¢æŸ¥ LINE é¡¯ç¤ºåç¨±æ˜¯å¦æœ‰å°æ‡‰è¨­å®š (è‹¥ UserID æ²’å°åˆ°)
            // 3. ç¶­æŒåŸæ¨£

            if (userId && mapping[userId]) {
                console.log(`[Name Mapping] UserID ${userId} mapped to ${mapping[userId]}`);
                appState.user.displayName = mapping[userId];
                updateUserProfileUI();
                // alert(`æˆåŠŸå°æ‡‰ï¼\nID: ${userId}\nåŸæœ¬: ${originalName}\nå°æ‡‰: ${mapping[userId]}`); // Debug
            } else if (originalName && mapping[originalName]) {
                console.log(`[Name Mapping] DisplayName ${originalName} mapped to ${mapping[originalName]}`);
                appState.user.displayName = mapping[originalName];
                updateUserProfileUI();
                // alert(`æˆåŠŸå°æ‡‰ (ä¾æš±ç¨±)ï¼\nåŸæœ¬: ${originalName}\nå°æ‡‰: ${mapping[originalName]}`); // Debug
            } else {
                // è‹¥æ‰¾ä¸åˆ°å°æ‡‰ï¼Œè·³å‡ºæç¤º (é™¤éŒ¯ç”¨)
                // è«‹ç¢ºèª GAS æ˜¯å¦æœ‰ç™¼å¸ƒæ–°ç‰ˆæœ¬ï¼Œä»¥åŠ Google Sheet è¡¨æ ¼è¨­å®šæ˜¯å¦æ­£ç¢º
                const keys = Object.keys(mapping);
                console.log("Mapping keys:", keys);
                // alert(`[é™¤éŒ¯è³‡è¨Š]\n\næ‚¨çš„ ID: ${userId}\næ‚¨çš„æš±ç¨±: ${originalName}\n\nç³»çµ±ç›®å‰è®€åˆ°çš„è¨­å®šæª”ç­†æ•¸: ${keys.length}\n\nè‹¥ç­†æ•¸ç‚º 0ï¼Œä»£è¡¨å‰ç«¯æ²’è®€åˆ°è¨­å®š (è«‹æª¢æŸ¥ GAS ç™¼å¸ƒ)ã€‚\nè‹¥æœ‰ç­†æ•¸ä½†æ²’è®Šï¼Œä»£è¡¨ ID æˆ–æš±ç¨±æ²’å°åˆ°ã€‚`);
            }
        }

        function updateUserProfileUI() {
            if (DOM.userName) DOM.userName.value = appState.user.displayName;
            if (DOM.userId) DOM.userId.value = appState.user.userId;
            if (appState.user.pictureUrl && DOM.userPicture) {
                DOM.userPicture.src = appState.user.pictureUrl;
            }
        }

        // ==========================================
        // 3. API è™•ç†
        // ==========================================
        async function fetchEvents() {
            if (!GAS_URL) return;
            try {
                const res = await fetch(`${GAS_URL}?action=getEvents`);
                appState.events = await res.json();
            } catch (e) {
                console.warn("API Error (getEvents)", e);
            }
        }

        async function fetchSettings() {
            if (!GAS_URL) return;
            try {
                const res = await fetch(`${GAS_URL}?action=getSettings`);
                appState.settings = await res.json();
                // å·²ç§»é™¤ä¸‹æ‹‰é¸å–®å¡«å…¥é‚è¼¯ï¼ˆæ”¹ç‚ºæ‰‹å‹•è¼¸å…¥ï¼‰
            } catch (e) {
                console.warn("API Error (getSettings)", e);
            }
        }

        async function fetchMyRegistrations() {
            if (!appState.user.userId || !GAS_URL) return;
            try {
                // å˜—è©¦æŠ“å–å ±åç´€éŒ„
                const res = await fetch(`${GAS_URL}?action=getMyRegistrations&userId=${appState.user.userId}`);
                const data = await res.json();
                appState.myRegistrations = Array.isArray(data) ? data : [];
            } catch (e) {
                console.warn("Fetch Registrations Failed", e);
            }
        }

        async function fetchStats(forceRefresh = false) {
            const e = appState.currentEvent;
            if (!e || !GAS_URL) return;

            if (forceRefresh) {
                DOM.statTotal.innerHTML = '<i class="animate-spin" data-lucide="loader-2"></i>';
                refreshIcons();
            }

            try {
                const res = await fetch(`${GAS_URL}?action=stats&eventId=${e.id}&_=${Date.now()}`);
                appState.currentStats = await res.json();

                animateValue(DOM.statTotal, 0, appState.currentStats.totalPeople || 0, 500);

                let secValue = 0;
                if (e.type === 'travel') {
                    secValue = appState.currentStats.totalRooms || 0;
                } else if (e.type === 'banquet') {
                    secValue = appState.currentStats.tableCount || 0;
                } else {
                    secValue = appState.currentStats.secondary || 0;
                }

                animateValue(DOM.statSecVal, 0, secValue, 500);
            } catch (err) {
                console.warn("Fetch Stats Failed", err);
            }
        }

        async function fetchDetails() {
            if (!GAS_URL) return [];
            try {
                const res = await fetch(`${GAS_URL}?action=getDetails&eventId=${appState.currentEvent.id}`);
                return await res.json();
            } catch (e) { return []; }
        }

        async function apiSubmit(data) {
            if (GAS_URL) {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(data)
                });
                return await res.json();
            }
        }

        // ==========================================
        // 4. æ ¸å¿ƒé‚è¼¯ (å ±åèˆ‡å°èˆª)
        // ==========================================
        async function enterEventDetail(eventId) {
            const event = appState.events.find(e => e.id === eventId);
            if (!event) return;

            // â˜…ã€ä¿®æ­£é» 2ã€‘ä¸€é»æ“Šå°±é¡¯ç¤º Loading Toastï¼Œæå‡é«”é©—
            showToast("æ­£åœ¨è®€å–æ´»å‹•è©³æƒ…...");

            appState.currentEvent = event;
            // ç«‹å³æ¸…é™¤çµ±è¨ˆä»¥é¿å…é¡¯ç¤ºèˆŠè³‡æ–™
            appState.currentStats = {};
            appState.cachedDetails = null;
            DOM.statTotal.innerText = "-";
            DOM.statSecVal.innerText = "-";

            resetFormState();

            appState.historyStack.push('detail');
            switchView('view-activity-detail');
            DOM.headerTitle.innerText = event.name;

            // 3. æ¸²æŸ“éœæ…‹è³‡è¨Š (åˆå§‹)
            renderEventStaticInfo();

            // 4. å¹³è¡ŒæŠ“å–ä»¥æå‡é€Ÿåº¦
            // ä½¿ç”¨ Promise.all åŒæ­¥æŠ“å–çµ±è¨ˆèˆ‡æª¢æŸ¥å ±å
            await Promise.all([
                fetchStats(),
                checkMyRegistration()
            ]);

            // 5. é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ä¸‹æ‹‰é¸å–®çµ±è¨ˆ
            renderEventStaticInfo();
        }

        async function checkMyRegistration() {
            if (!appState.user.userId) return;

            try {
                const details = await fetchDetails();
                const myRecord = details.find(r => r.userId === appState.user.userId || r.name === appState.user.displayName);

                if (myRecord) {
                    fillFormWithRecord(myRecord);
                }
            } catch (e) { console.error(e); }
        }

        function fillFormWithRecord(record) {
            DOM.formAction.value = 'update';

            if (isEventOpen(appState.currentEvent)) {
                DOM.submitBtn.innerHTML = '<span>æ›´æ–°è³‡æ–™</span><i data-lucide="refresh-cw" class="w-4 h-4"></i>';
                DOM.submitBtn.classList.replace('bg-[#06c755]', 'bg-blue-600');
                DOM.submitBtn.classList.replace('hover:bg-green-600', 'hover:bg-blue-700');
                DOM.submitBtn.disabled = false;
                DOM.cancelBtn.classList.remove('hidden');
            } else {
                DOM.submitBtn.innerText = "å·²å ±å (æ´»å‹•å·²çµæŸ)";
                DOM.submitBtn.className = "flex-1 bg-gray-400 text-white font-bold py-3.5 rounded-xl cursor-not-allowed flex justify-center items-center gap-2";
                DOM.submitBtn.disabled = true;
                DOM.cancelBtn.classList.add('hidden');
            }

            DOM.formTitle.innerText = "ç·¨è¼¯æ‚¨çš„å ±å";

            // ä½¿ç”¨çµ±ä¸€æ¬„ä½æ˜ å°„å–å¾—æ¬„ä½å€¼
            const family = getIntField(record, 'family');
            const tableCount = getIntField(record, 'tableCount');
            const room = getField(record, 'room');
            const pickup = getField(record, 'pickup');
            const guestCount = getIntField(record, 'guestCount');
            const sponsor = getField(record, 'sponsor');

            // å¡«å…¥æ¬„ä½
            document.getElementById('family-count').value = family;
            if (tableCount) document.getElementById('table-count').value = tableCount;

            if (room && room !== 'ç„¡') document.getElementById('room-type').value = room;
            if (pickup && pickup !== 'ç„¡') document.getElementById('pickup-loc').value = pickup;

            // é‚„åŸä¾†è³“åˆ—è¡¨
            appState.guestList = [];
            const parsedGuests = parseGuestData(record);

            if (parsedGuests.length > 0) {
                appState.guestList = parsedGuests.map(g => ({
                    ...g,
                    id: g.id || ('g_' + Date.now() + Math.random().toString(36).substr(2, 5))
                }));
                renderGuestList();
            } else if (guestCount > 0) {
                for (let i = 0; i < guestCount; i++) {
                    const id = 'g_' + Date.now() + Math.random().toString(36).substr(2, 5) + i;
                    appState.guestList.push({ id, name: `ä¾†è³“ ${i + 1}`, count: 1, pickup: '', room: '' });
                }
                renderGuestList();
            }

            restoreSponsorList(sponsor);
            refreshIcons();
            showToast("å·²è¼‰å…¥æ‚¨çš„å ±åè³‡æ–™");
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const originalContent = DOM.submitBtn.innerHTML;

            if (!validateForm()) return;

            DOM.submitBtn.disabled = true;
            DOM.submitBtn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> è™•ç†ä¸­...';
            refreshIcons();

            const formData = {
                action: DOM.formAction.value,
                eventId: appState.currentEvent.id,
                eventType: appState.currentEvent.type,
                eventName: appState.currentEvent.name,
                userId: appState.user.userId,
                displayName: DOM.userName.value,
                pictureUrl: appState.user.pictureUrl,
                familyCount: document.getElementById('family-count').value,
                guestList: JSON.stringify(appState.guestList),
                sponsorList: JSON.stringify(appState.sponsorList),
                roomType: document.getElementById('room-type').value,
                pickupLoc: document.getElementById('pickup-loc').value,
                tableCount: document.getElementById('table-count').value
            };

            try {
                await apiSubmit(formData);
                showToast(formData.action === 'update' ? "æ›´æ–°æˆåŠŸï¼" : "å ±åæˆåŠŸï¼");
                if (!appState.myRegistrations.includes(appState.currentEvent.id)) {
                    appState.myRegistrations.push(appState.currentEvent.id);
                }
                await fetchStats();
                await checkMyRegistration();
                renderEventStaticInfo();
            } catch (err) {
                showToast("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦");
            } finally {
                DOM.submitBtn.disabled = false;
                DOM.submitBtn.innerHTML = originalContent;
                refreshIcons();
            }
        }

        async function handleCancel() {
            const confirmed = await showConfirm("ç¢ºå®šè¦å–æ¶ˆæ­¤æ´»å‹•çš„å ±åå—ï¼Ÿ<br>å–æ¶ˆå¾Œåé¡å°‡æœƒé‡‹å‡ºã€‚");
            if (!confirmed) return;

            DOM.cancelBtn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>';
            refreshIcons();

            try {
                await apiSubmit({
                    action: 'cancel',
                    eventId: appState.currentEvent.id,
                    userId: appState.user.userId
                });
                showToast("å·²å–æ¶ˆå ±å");
                appState.myRegistrations = appState.myRegistrations.filter(id => id !== appState.currentEvent.id);
                resetFormState();
                await fetchStats();
                renderEventStaticInfo();
            } catch (err) {
                showToast("å–æ¶ˆå¤±æ•—");
            } finally {
                DOM.cancelBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
                refreshIcons();
            }
        }

        // ==========================================
        // 5. UI RENDERING & HELPERS
        // ==========================================
        function resetFormState() {
            appState.guestList = [];
            appState.sponsorList = [];
            DOM.regForm.reset();
            DOM.guestContainer.innerHTML = '';
            DOM.sponsorContainer.innerHTML = '';

            const formInputs = document.querySelectorAll('#regForm input, #regForm select, #regForm button');
            formInputs.forEach(el => el.disabled = false);

            DOM.formAction.value = 'register';
            DOM.submitBtn.innerHTML = '<span>ç¢ºèªå ±å</span><i data-lucide="send" class="w-4 h-4"></i>';
            DOM.submitBtn.className = "flex-1 bg-[#06c755] text-white font-bold py-3.5 rounded-xl hover:bg-green-600 transition shadow-md active:scale-95 flex justify-center items-center gap-2";
            DOM.submitBtn.disabled = false;

            DOM.cancelBtn.classList.add('hidden');
            DOM.formTitle.innerText = "å¡«å¯«å ±åè³‡æ–™";
            DOM.userName.value = appState.user.displayName;
        }

        function renderEventStaticInfo() {
            const e = appState.currentEvent;
            // â˜… å®‰å…¨æª¢æŸ¥ï¼šé˜²æ­¢è³‡æ–™å°šæœªè¼‰å…¥æ™‚å ±éŒ¯
            if (!e) return;

            // æ–‡å­—æ¬„ä½
            document.getElementById('display-name').innerText = e.name;
            document.getElementById('display-organizer').innerText = e.organizer;
            document.getElementById('display-location').innerText = e.location;
            document.getElementById('display-address').innerText = e.address;
            document.getElementById('map-link').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.address)}`;

            // æ™‚é–“é¡¯ç¤º
            const timeDiv = document.getElementById('display-time-container');
            if (e.type === 'travel' && e.time.includes('~')) {
                const [start, end] = e.time.split('~');
                // æ—…éŠæ´»å‹•ä½¿ç”¨æ—¥æœŸå°ˆç”¨æ ¼å¼
                timeDiv.innerHTML = `<div class="flex flex-col text-sm"><span class="text-green-700 font-bold">èµ·ï¼š${formatDateOnly(start)}</span><span class="text-red-700 font-bold">æ­¢ï¼š${formatDateOnly(end)}</span></div>`;
            } else {
                timeDiv.innerText = formatDate(e.time);
            }

            // æª¢æŸ¥æ˜¯å¦é—œé–‰ -> åœç”¨è¡¨å–®
            const isOpen = isEventOpen(e);
            if (!isOpen) {
                // åœç”¨è¡¨å–®å…§æ‰€æœ‰è¼¸å…¥æ¡†
                const formInputs = document.querySelectorAll('#regForm input, #regForm select, #regForm button');
                formInputs.forEach(el => el.disabled = true);

                DOM.submitBtn.innerText = "æ´»å‹•å·²çµæŸ";
                DOM.submitBtn.className = "flex-1 bg-gray-400 text-white font-bold py-3.5 rounded-xl cursor-not-allowed flex justify-center items-center gap-2";
                DOM.submitBtn.disabled = true;
            }

            // æˆªæ­¢æ—¥æœŸ
            if (e.deadline) {
                const isExpired = new Date() > new Date(e.deadline);
                const color = isExpired ? "text-red-500 font-bold" : "text-gray-400";
                timeDiv.innerHTML += `<div class="mt-1 pt-1 border-t border-gray-100 text-xs ${color} flex items-center gap-1"><i data-lucide="hourglass" class="w-3 h-3"></i> æˆªæ­¢ï¼š${formatDate(e.deadline)}</div>`;

                if (isExpired && isOpen) { // åƒ…åœ¨æ´»å‹•ä»é–‹æ”¾ä½†å·²éæˆªæ­¢æ™‚é–“æ™‚é¡¯ç¤º
                    DOM.submitBtn.disabled = true;
                    DOM.submitBtn.innerText = "å ±åå·²æˆªæ­¢";
                    DOM.submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    DOM.submitBtn.classList.remove('bg-[#06c755]', 'hover:bg-green-600');
                }
            }

            // ç‹€æ…‹åˆ‡æ›æŒ‰éˆ• - æ¬Šé™æª¢æŸ¥
            if (appState.user.userId && e.creatorId && appState.user.userId === e.creatorId) {
                DOM.managerControls.classList.remove('hidden');
            } else {
                DOM.managerControls.classList.add('hidden');
            }

            const statusBtn = document.getElementById('btn-status-toggle');
            statusBtn.className = `text-xs px-3 py-1.5 rounded-full font-bold border transition flex items-center gap-1 ${isOpen ? 'bg-red-50 text-red-600 border-red-200 hover:bg-red-100' : 'bg-green-50 text-green-600 border-green-200 hover:bg-green-100'}`;
            statusBtn.innerHTML = isOpen ? '<i data-lucide="stop-circle" class="w-3 h-3"></i> é—œé–‰æ´»å‹•' : '<i data-lucide="play-circle" class="w-3 h-3"></i> é–‹å•Ÿæ´»å‹•';

            // æ¬„ä½é¡¯ç¤ºç‹€æ…‹
            const fields = {
                travel: document.getElementById('field-travel'),
                banquet: document.getElementById('field-banquet'),
                itinerary: document.getElementById('travel-itinerary-section'),
                guestTravel: document.getElementById('guest-travel-options')
            };

            // é‡ç½®
            Object.values(fields).forEach(el => el.classList.add('hidden'));
            DOM.statSecLabel.innerText = "è´ŠåŠ©ç­†æ•¸";

            if (e.type === 'travel') {
                fields.travel.classList.remove('hidden');
                fields.guestTravel.classList.remove('hidden');
                if (e.itinerary) {
                    fields.itinerary.classList.remove('hidden');
                    renderItinerary(e.itinerary, e.time);
                }
                DOM.statSecLabel.innerText = "å·²è¨‚æˆ¿æ•¸";

                // å¡«å…¥é¸é …
                populateSelect('pickup-loc', e.pickupOpts);
                populateSelect('add-guest-pickup', e.pickupOpts);
                populateRoomOptions('room-type', e.roomOpts);
                populateRoomOptions('add-guest-room', e.roomOpts);

            } else if (e.type === 'banquet') {
                fields.banquet.classList.remove('hidden');
                DOM.statSecLabel.innerText = "é è¨‚æ¡Œæ•¸";
            }

            refreshIcons();
        }

        // --- æ¸²æŸ“åˆ—è¡¨ ---
        function renderGuestList() {
            DOM.guestContainer.innerHTML = '';
            appState.guestList.forEach((g, i) => {
                let details = [];
                if (g.count > 1) details.push(`${g.count}äºº`);
                if (g.pickup) details.push(escapeHtml(g.pickup));
                if (g.room) details.push(escapeHtml(g.room));
                const subtext = details.length > 0 ? `<span class="text-xs text-gray-400 ml-1">(${details.join(', ')})</span>` : '';

                DOM.guestContainer.innerHTML += `
                    <div class="flex justify-between items-center bg-white border border-gray-200 pl-3 pr-2 py-2 rounded-lg text-sm shadow-sm animate-fade-in">
                        <div class="flex items-center gap-2">
                            <div class="w-1.5 h-1.5 rounded-full bg-orange-400"></div>
                            <span class="font-medium text-gray-700">${escapeHtml(g.name)} ${subtext}</span>
                        </div>
                        <div class="flex gap-2 items-center">
                            <i data-lucide="edit-2" class="w-4 h-4 tag-action tag-edit" onclick="editGuest(${i})"></i>
                            <i data-lucide="x" class="w-4 h-4 tag-action tag-remove" onclick="removeGuest('${g.id}')"></i>
                        </div>
                    </div>`;
            });
            refreshIcons();
        }

        function renderSponsorList() {
            DOM.sponsorContainer.innerHTML = '';
            appState.sponsorList.forEach((s, i) => {
                DOM.sponsorContainer.innerHTML += `
                    <div class="flex justify-between items-center bg-white border border-gray-200 pl-3 pr-2 py-2 rounded-lg text-sm shadow-sm animate-fade-in">
                        <div class="flex items-center gap-2">
                            <i data-lucide="gift" class="w-3.5 h-3.5 text-purple-500"></i>
                            <span class="font-medium text-gray-700">${escapeHtml(s)}</span>
                        </div>
                        <div class="flex gap-2 items-center">
                            <i data-lucide="edit-2" class="w-4 h-4 tag-action tag-edit" onclick="editSponsor(${i})"></i>
                            <i data-lucide="x" class="w-4 h-4 tag-action tag-remove" onclick="removeSponsor(${i})"></i>
                        </div>
                    </div>`;
            });
            refreshIcons();
        }

        function editGuest(i) {
            const g = appState.guestList[i];
            document.getElementById('add-guest-name').value = g.name;
            document.getElementById('add-guest-count').value = g.count;
            if (g.pickup) document.getElementById('add-guest-pickup').value = g.pickup;
            if (g.room) document.getElementById('add-guest-room').value = g.room;

            // ç§»é™¤ç•¶å‰é …ç›®ä»¥ä¾¿é‡æ–°åŠ å…¥
            appState.guestList.splice(i, 1);
            renderGuestList();
            showToast("å·²è¼‰å…¥è³‡æ–™è‡³è¼¸å…¥æ¡†ï¼Œä¿®æ”¹å¾Œè«‹é»é¸ã€ŒåŠ å…¥åå–®ã€");
        }

        function editSponsor(i) {
            const s = appState.sponsorList[i];
            // è§£æå­—ä¸²å›å¡« UI çš„é‚è¼¯
            // Format 1: é…’é¡: 5ç“¶
            // Format 2: ç´…åŒ…: 1000å…ƒ
            // Format 3: å…¶ä»–: ...

            if (s.startsWith("é…’é¡:")) {
                document.querySelector('input[name="addSponsorType"][value="alcohol"]').checked = true;
                renderAddSponsorUI();
                const content = s.substring(4); // "5ç“¶"
                const unit = content.includes('ç®±') ? 'ç®±' : 'ç“¶';
                const qty = parseInt(content);
                document.getElementById('sp-qty').value = qty;
                document.getElementById('sp-unit').value = unit;

            } else if (s.startsWith("ç´…åŒ…:")) {
                document.querySelector('input[name="addSponsorType"][value="money"]').checked = true;
                renderAddSponsorUI();
                // "ç´…åŒ…: 1000å…ƒ"
                const money = parseInt(s.match(/\d+/)[0]);
                document.getElementById('sp-money').value = money;

            } else {
                // "å…¶ä»–: ..."
                document.querySelector('input[name="addSponsorType"][value="other"]').checked = true;
                renderAddSponsorUI();
                const content = s.substring(4);
                document.getElementById('sp-other').value = content;
            }

            appState.sponsorList.splice(i, 1);
            renderSponsorList();
            showToast("å·²è¼‰å…¥è³‡æ–™è‡³è¼¸å…¥æ¡†ï¼Œä¿®æ”¹å¾Œè«‹é»é¸ã€Œæ–°å¢è´ŠåŠ©ã€");
        }

        function renderEventGrid(type) {
            const container = document.getElementById('event-grid-container');
            const loading = document.getElementById('event-list-loading');

            if (!appState.isDataLoaded) {
                loading.classList.remove('hidden');
                container.innerHTML = '';
                return;
            }

            loading.classList.add('hidden');
            container.innerHTML = '';

            const filtered = appState.events.filter(e => {
                if (type === 'all') return isEventOpen(e) && e.isActiveValue !== '';
                return normalizeType(e.type) === type && isEventOpen(e) && e.isActiveValue !== '';
            }).sort((a, b) => {
                // è§£ææ—¥æœŸï¼ˆè™•ç†æ—¥æœŸç¯„åœèˆ‡é©—è­‰ ISO æ ¼å¼ï¼‰
                const getTime = (t) => {
                    if (!t) return 0;
                    // è‹¥ç‚ºç¯„åœ "start~end"ï¼Œå–é–‹å§‹æ—¥æœŸ
                    const start = t.includes('~') ? t.split('~')[0] : t;
                    return new Date(start).getTime();
                };
                return getTime(a.time) - getTime(b.time);
            });

            if (filtered.length === 0) {
                DOM.noEventsMsg.classList.remove('hidden');
            } else {
                DOM.noEventsMsg.classList.add('hidden');
                filtered.forEach(e => {
                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100 card-hover cursor-pointer flex items-center gap-4 relative overflow-hidden group";
                    card.onclick = () => enterEventDetail(e.id);

                    let icon, colorClass, bgClass;
                    switch (normalizeType(e.type)) {
                        case 'banquet': icon = 'utensils'; colorClass = 'text-orange-600'; bgClass = 'bg-orange-50'; break;
                        case 'travel': icon = 'bus'; colorClass = 'text-blue-600'; bgClass = 'bg-blue-50'; break;
                        default: icon = 'calendar'; colorClass = 'text-green-600'; bgClass = 'bg-green-50';
                    }

                    // æˆªæ­¢è­¦å‘Š / å·²å ±åæ¨™ç±¤é‚è¼¯
                    let badge = '';
                    // å„ªå…ˆé¡¯ç¤ºå·²å ±åï¼Œå³ä½¿å·²æˆªæ­¢
                    if (appState.myRegistrations.includes(e.id)) {
                        badge = '<span class="absolute top-0 right-0 bg-green-500 text-white text-[10px] px-2 py-0.5 rounded-bl-lg font-bold">å·²å ±å</span>';
                    } else if (e.deadline && new Date() > new Date(e.deadline)) {
                        badge = '<span class="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-bl-lg font-bold">å·²æˆªæ­¢</span>';
                    }

                    card.innerHTML = `
                        ${badge}
                        <div class="${bgClass} w-12 h-12 rounded-2xl flex items-center justify-center ${colorClass} shrink-0 group-hover:scale-110 transition-transform">
                            <i data-lucide="${icon}" class="w-6 h-6"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-gray-800 text-lg mb-1 leading-snug">${escapeHtml(e.name)}</h3>
                            <div class="text-xs text-gray-500 mb-2 break-words">ä¸»è¾¦: ${escapeHtml(e.organizer)}</div>
                            <div class="flex items-center gap-3 text-xs text-gray-500">
                                <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${formatDateShort(e.time)}</span>
                                <span class="flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${escapeHtml(e.location)}</span>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300"></i>
                    `;
                    container.appendChild(card);
                });
                refreshIcons();
            }
        }

        // --- è¦–çª—èˆ‡è©³ç´°è³‡è¨Šé‚è¼¯ ---
        async function openDetailsModal(filterType = 'all') {
            if (!appState.currentEvent) return;
            const modal = document.getElementById('details-modal');
            const content = document.getElementById('modal-content');

            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('translate-y-full', 'opacity-0');
                content.classList.add('translate-y-10', 'sm:translate-y-0', 'opacity-100');
            }, 10);

            // å‹•æ…‹ä¿®æ”¹æ¨™é¡Œ
            const titleEl = document.querySelector('#details-modal h3');
            if (filterType === 'people') {
                titleEl.innerHTML = '<i data-lucide="users" class="w-5 h-5 text-gray-600"></i> äººå“¡åå–®';
            } else if (filterType === 'secondary') {
                const type = appState.currentEvent.type;
                const icon = type === 'travel' ? 'bus' : 'gift';
                const text = type === 'travel' ? 'ä½å®¿èˆ‡äº¤é€š' : 'è´ŠåŠ©èˆ‡èªæ¡Œ';
                titleEl.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 text-gray-600"></i> ${text}æ˜ç´°`;
            } else {
                titleEl.innerHTML = '<i data-lucide="list" class="w-5 h-5 text-gray-600"></i> è©³ç´°åå–®';
            }
            refreshIcons();

            // å¡«å…¥æ‘˜è¦
            const sumDiv = document.getElementById('modal-summary');
            sumDiv.innerHTML = '';
            if (appState.currentEvent.type === 'travel') {
                const pMap = appState.currentStats.pickupCounts || {};
                const rMap = appState.currentStats.roomCounts || {};
                let html = '';
                if (Object.keys(pMap).length) html += `<div class="bg-white rounded p-1.5"><div class="font-bold mb-1 text-gray-500">ğŸ“ ä¸Šè»Šåœ°é»</div>${Object.entries(pMap).map(([k, v]) => `<span class="inline-block bg-gray-100 px-1.5 rounded text-[10px] mr-1 mb-1">${k}:${v}</span>`).join('')}</div>`;
                if (Object.keys(rMap).length) html += `<div class="bg-white rounded p-1.5"><div class="font-bold mb-1 text-gray-500">ğŸ› æˆ¿å‹çµ±è¨ˆ</div>${Object.entries(rMap).map(([k, v]) => `<span class="inline-block bg-gray-100 px-1.5 rounded text-[10px] mr-1 mb-1">${k}:${v}</span>`).join('')}</div>`;
                sumDiv.innerHTML = html;
            } else if (appState.currentEvent.type === 'banquet') {
                sumDiv.innerHTML = `<div class="col-span-2 bg-white rounded p-2 text-center font-bold text-red-500">ç¸½è¨ˆé è¨‚: ${appState.currentStats.tableCount} æ¡Œ</div>`;
            }

            const listContainer = document.getElementById('details-lists-container');
            const loading = document.getElementById('modal-loading');
            const empty = document.getElementById('modal-empty');

            listContainer.classList.add('hidden');
            loading.classList.remove('hidden');
            empty.classList.add('hidden');

            const data = await fetchDetails();
            appState.cachedDetails = data; // â˜… å¿«å–è³‡æ–™ä»¥ä¾›åŒæ­¥è¤‡è£½ä½¿ç”¨
            loading.classList.add('hidden');

            if (!data || data.length === 0) {
                empty.classList.remove('hidden');
                return;
            }

            listContainer.classList.remove('hidden');
            renderDetailLists(data);

            // â˜… æ ¹æ“š filterType éš±è—ä¸éœ€è¦çš„å€å¡Š
            const listP = document.getElementById('details-list-people');
            const labelP = listP.previousElementSibling;
            const listT = document.getElementById('details-list-travel');
            const labelT = document.getElementById('travel-separator');
            const listI = document.getElementById('details-list-items');
            const labelI = document.getElementById('details-separator');

            if (filterType === 'people') {
                if (listT) listT.classList.add('hidden');
                if (labelT) labelT.classList.add('hidden');
                if (listI) listI.classList.add('hidden');
                if (labelI) labelI.classList.add('hidden');
                listP.classList.remove('hidden');
                labelP.classList.remove('hidden');
            } else if (filterType === 'secondary') {
                listP.classList.add('hidden');
                labelP.classList.add('hidden');
                const evtType = appState.currentEvent.type;
                if (evtType === 'travel') {
                    if (listT) listT.classList.remove('hidden');
                    if (labelT) labelT.classList.remove('hidden');
                    if (listI) listI.classList.add('hidden');
                    if (labelI) labelI.classList.add('hidden');
                } else {
                    if (listI) listI.classList.remove('hidden');
                    if (labelI) labelI.classList.remove('hidden');
                    if (listT) listT.classList.add('hidden');
                    if (labelT) labelT.classList.add('hidden');
                }
            }
        }

        // ä¸åˆ†å¤§å°å¯«å°‹æ‰¾å€¼çš„è¼”åŠ©å‡½å¼
        function findCaseInsensitiveValue(row, candidates) {
            if (!row) return undefined;
            // 1. ç›´æ¥åŒ¹é… (å¿«)
            for (const key of candidates) {
                if (row[key] !== undefined && row[key] !== '') return row[key];
            }
            // 2. ä¸åˆ†å¤§å°å¯«æƒæ (æ…¢)
            const keys = Object.keys(row);
            for (const c of candidates) {
                const lowerC = c.toLowerCase().replace(/\s/g, '');
                for (const k of keys) {
                    if (k.toLowerCase().replace(/\s/g, '') === lowerC) {
                        return row[k];
                    }
                }
            }
            return undefined;
        }

        function renderDetailLists(data) {
            const listP = document.getElementById('details-list-people');
            const listT = document.getElementById('details-list-travel');
            const listI = document.getElementById('details-list-items');

            listP.innerHTML = ''; listT.innerHTML = ''; listI.innerHTML = '';
            document.getElementById('travel-separator').classList.add('hidden');
            listT.classList.add('hidden');
            document.getElementById('details-separator').classList.add('hidden');
            listI.classList.add('hidden');

            let hasTravel = false;
            let hasItems = false;


            data.forEach((row, idx) => {
                const name = findCaseInsensitiveValue(row, ['name', 'Name', 'å§“å', 'UserName', 'username']) || 'Unknown';
                const safeName = escapeHtml(name);
                const family = getIntField(row, 'family');

                const guestData = parseGuestData(row);
                const guestCountFallback = getIntField(row, 'guestCount');

                const guestTotalCount = guestData.reduce((acc, g) => acc + g.count, 0);
                const finalGuestCount = guestTotalCount > 0 ? guestTotalCount : guestCountFallback;
                const total = 1 + family + finalGuestCount;

                let nameSuffix = '';
                if (total > 1) {
                    nameSuffix = ` <span class="text-gray-600 font-bold">*${total}</span>`;
                }

                let subHtml = '';
                if (guestData.length > 0) {
                    subHtml = guestData.map(g => `<div class="pl-8 text-gray-600 text-sm mt-0.5">ä¾†è³“ï¼š${escapeHtml(g.name)}</div>`).join('');
                } else {
                    const guestNameStr = getField(row, 'guestName');
                    if (guestNameStr && guestNameStr !== 'ç„¡') {
                        subHtml = `<div class="pl-8 text-gray-600 text-sm mt-0.5">ä¾†è³“ï¼š${escapeHtml(guestNameStr)}</div>`;
                    }
                }

                const pickup = getField(row, 'pickup');
                const room = getField(row, 'room');
                const tableCount = getIntField(row, 'tableCount');
                const sponsor = getField(row, 'sponsor');

                const num = (idx + 1).toString().padStart(2, '0');

                // â˜… æ–°å¢ï¼šå–å¾—è§’è‰²æ¨™ç±¤
                const roles = getParticipantRoles(name, appState.currentEvent);
                let tagHtml = '';
                if (roles.length > 0) {
                    tagHtml = roles.map(r => `<span class="text-[12px] font-bold ml-1.5 flex items-center" style="color:${r.color};">${r.label}</span>`).join('');
                }

                listP.innerHTML += `
                    <li class="px-4 py-3 hover:bg-gray-50 transition border-b border-gray-50 last:border-0">
                        <div class="flex items-center gap-1.5 mb-0.5 flex-wrap">
                            <span class="text-gray-400 font-mono text-sm">${num}.</span>
                            <span class="font-bold text-gray-800 text-base inline-flex items-center flex-wrap">${safeName}${tagHtml}${nameSuffix}</span>
                        </div>
                        ${subHtml}
                    </li>`;

                if (appState.currentEvent.type === 'travel') {
                    // æª¢æŸ¥ä¸»è¦äººå“¡
                    if ((pickup && pickup !== 'ç„¡') || (room && room !== 'ç„¡')) {
                        hasTravel = true;
                        listT.innerHTML += `
                            <li class="px-4 py-2 flex justify-between items-center hover:bg-gray-50 text-sm">
                                <span class="font-medium text-gray-700">${safeName}</span>
                                <div class="text-right text-xs text-gray-500">
                                    ${pickup && pickup !== 'ç„¡' ? `<div class="text-blue-600">${escapeHtml(pickup)}</div>` : ''}
                                    ${room && room !== 'ç„¡' ? `<div class="text-orange-600">${escapeHtml(room)}</div>` : ''}
                                </div>
                            </li>`;
                    }

                    // æª¢æŸ¥ä¾†è³“
                    guestData.forEach(g => {
                        if ((g.pickup && g.pickup !== 'ç„¡') || (g.room && g.room !== 'ç„¡')) {
                            hasTravel = true;
                            listT.innerHTML += `
                                <li class="px-4 py-2 flex justify-between items-center hover:bg-gray-50 text-sm">
                                    <span class="font-medium text-gray-700"><span class="text-xs text-gray-400 mr-1">è³“</span>${escapeHtml(g.name)}</span>
                                    <div class="text-right text-xs text-gray-500">
                                        ${g.pickup && g.pickup !== 'ç„¡' ? `<div class="text-blue-600">${escapeHtml(g.pickup)}</div>` : ''}
                                        ${g.room && g.room !== 'ç„¡' ? `<div class="text-orange-600">${escapeHtml(g.room)}</div>` : ''}
                                    </div>
                                </li>`;
                        }
                    });
                }

                const items = [];
                if (tableCount > 0) items.push(`èªæ¡Œ ${tableCount} æ¡Œ`);

                // ä½¿ç”¨è¼”åŠ©å‡½å¼è§£æè´ŠåŠ©
                const spList = parseSponsorData(sponsor);
                if (spList.length > 0) {
                    items.push(...spList);
                }

                if (items.length > 0) {
                    hasItems = true;
                    listI.innerHTML += `
                        <li class="px-4 py-3 hover:bg-gray-50">
                            <div class="flex justify-between items-start">
                                <span class="font-medium text-gray-800 text-sm">${safeName}</span>
                                <div class="text-right flex-1 pl-4">
                                    ${items.map(i => `<div class="text-xs text-purple-600 bg-purple-50 inline-block px-2 py-1 rounded mb-1 ml-1">${i}</div>`).join('')}
                                </div>
                            </div>
                        </li>`;
                }
            });

            if (hasTravel) {
                document.getElementById('travel-separator').classList.remove('hidden');
                listT.classList.remove('hidden');
            }
            if (hasItems) {
                document.getElementById('details-separator').classList.remove('hidden');
                listI.classList.remove('hidden');
            }
        }

        // ==========================================
        // 6. UTILITY FUNCTIONS
        // ==========================================

        /**
         * çµ±ä¸€è§£æä¾†è³“è³‡æ–™ï¼šæ”¯æ´å¤šç¨®æ ¼å¼ï¼ˆJSONã€JSON å­—ä¸²æˆ–èˆŠç‰ˆå­—ä¸²ï¼‰
         * ç„¡è«–æ˜¯ JSONã€Array é‚„æ˜¯ Stringï¼Œçµ±ä¸€è½‰ç‚ºæ¨™æº–æ ¼å¼ Array
         * å›å‚³ä¾†è³“ç‰©ä»¶é™£åˆ—ï¼š{ name, count, pickup, room }
         */

        function parseGuestData(row) {
            let guestData = [];
            if (!row || typeof row !== 'object') return guestData;

            // å®šç¾©å€™é¸éµå€¼ (æ–°å¢æ›´å¤šè®ŠåŒ–)
            const jsonKeys = ['guestList', 'guestJson', 'GuestJson', 'GuestList', 'guest_json', 'guest_list', 'ä¾†è³“è³‡æ–™JSON', 'ä¾†è³“è³‡æ–™', 'json', 'JSON', 'guests', 'Guests', 'extraData'];
            const nameKeys = ['guestName', 'GuestName', 'Guest Name', 'guest_name', 'Guest Names', 'Guest_Names', 'guestNames', 'guest_names', 'ä¾†è³“å§“å', 'ä¾†è³“', 'Guest', 'guest', 'memo', 'Memo', 'å‚™è¨»'];

            // ä½¿ç”¨å¼·å¥çš„è¼”åŠ©å‡½å¼å–å¾—æ•¸å€¼
            let guestJson = findCaseInsensitiveValue(row, jsonKeys);
            let guestNameStr = findCaseInsensitiveValue(row, nameKeys);

            // 1. å˜—è©¦è§£æ JSON
            if (guestJson && guestJson !== '[]' && guestJson !== 'ç„¡') {
                try {
                    const parsed = (typeof guestJson === 'string') ? JSON.parse(guestJson) : guestJson;
                    if (Array.isArray(parsed)) {
                        guestData = parsed.map(g => {
                            // è‹¥ g æ˜¯å­—ä¸² (ä¾‹å¦‚ ["Guest A", "Guest B"])
                            if (typeof g === 'string') {
                                return { name: g, count: 1, pickup: '', room: '' };
                            }
                            // è‹¥ g æ˜¯ç‰©ä»¶
                            return {
                                // â˜… é—œéµä¿®æ­£ï¼šå¢åŠ æª¢æŸ¥ guestName, GuestName ç­‰æ¬„ä½
                                name: g.name || g.Name || g['å§“å'] || g.guestName || g.GuestName || g['ä¾†è³“å§“å'] || '',
                                count: parseInt(g.count || g.Count || g['äººæ•¸']) || 1,
                                pickup: g.pickup || g.Pickup || '',
                                room: g.room || g.Room || ''
                            };
                        }).filter(g => g.name); // éæ¿¾æ‰æ²’æœ‰åå­—çš„é …ç›®
                    }
                } catch (e) {
                    // JSON è§£æå¤±æ•—ï¼Œå¿½ç•¥
                }
            }

            // 2. å‚™æ´ç­–ç•¥
            // è‹¥ JSON è§£æå¤±æ•—æˆ–ç‚ºç©ºï¼Œä¸” guestName ç‚ºç©ºï¼Œå˜—è©¦ä½¿ç”¨ guestJson ç•¶ä½œå­—ä¸² (è‹¥æ˜¯ç´”å­—ä¸²å¡«å…¥ guestList æ¬„ä½çš„æƒ…æ³)
            let sourceStr = guestNameStr;
            // åªæœ‰ç•¶ guestJson çœ‹èµ·ä¾†ä¸åƒ JSON (ä¸ä»¥ [ æˆ– { é–‹é ­) æ™‚ï¼Œæ‰æŠŠå®ƒç•¶ä½œæ™®é€šå­—ä¸²è™•ç†
            if ((!sourceStr || sourceStr === 'ç„¡') && guestJson && typeof guestJson === 'string' && !guestJson.trim().startsWith('[') && !guestJson.trim().startsWith('{')) {
                sourceStr = guestJson;
            }

            if (guestData.length === 0 && sourceStr && sourceStr !== 'ç„¡') {
                // ç¢ºä¿ç‚ºå­—ä¸²
                sourceStr = String(sourceStr);

                // æ–°å¢æ›è¡Œç¬¦è™Ÿæ”¯æ´
                const guestEntries = sourceStr.split(/[,ã€;\n]\s*/);
                guestEntries.forEach(g => {
                    if (!g.trim()) return;
                    let parts = g.split('|');
                    let namePart = parts[0].trim();
                    let displayName = namePart;
                    let count = 1;

                    // è§£æ "åå­—(2)" æˆ– "åå­—(+2)" é€™ç¨®æ ¼å¼
                    const match = namePart.match(/(.*?)\((\+)?(\d+)\)/);
                    if (match) {
                        displayName = match[1].trim();
                        count = parseInt(match[3]); // match[3] is the number
                    }

                    guestData.push({
                        name: displayName,
                        count: count,
                        pickup: parts[1] && parts[1] !== 'ç„¡' ? parts[1] : '',
                        room: parts[2] && parts[2] !== 'ç„¡' ? parts[2] : ''
                    });
                });
            }

            return guestData;
        }

        /**
         * è§£æè´ŠåŠ©è³‡æ–™ï¼ˆæ”¯æ´å„ç¨®æ ¼å¼ï¼‰
         * å›å‚³è´ŠåŠ©å­—ä¸²é™£åˆ—
         */
        function parseSponsorData(input) {
            let list = [];
            if (!input || input === 'ç„¡') return list;

            // 1. å˜—è©¦ JSON
            try {
                const json = (typeof input === 'string' && (input.startsWith('[') || input.startsWith('{')))
                    ? JSON.parse(input)
                    : input;
                if (Array.isArray(json)) {
                    return json;
                }
            } catch (e) { /* Not JSON */ }

            // 2. å‚™æ´ï¼šåˆ†å‰²å­—ä¸²
            if (typeof input === 'string') {
                const items = input.split(/[,ã€;]\s*/);
                items.forEach(item => {
                    const clean = item.trim();
                    if (clean && clean !== 'ç„¡') {
                        list.push(clean);
                    }
                });
            }
            return list;
        }

        // refreshIcons å·²åœ¨ script é ‚éƒ¨å®šç¾©ï¼ˆæ‰¹æ¬¡ç‰ˆæœ¬ï¼‰

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');

            if (viewId === 'view-home') {
                DOM.btnBack.classList.add('hidden');
                DOM.btnShare.classList.add('hidden');
                appState.historyStack = ['home'];
            } else if (viewId === 'view-activity-detail') {
                DOM.btnBack.classList.remove('hidden');
                DOM.btnShare.classList.remove('hidden');
            } else {
                DOM.btnBack.classList.remove('hidden');
                DOM.btnShare.classList.add('hidden');
            }
            window.scrollTo(0, 0);
        }

        function handleBackNav() {
            const current = appState.historyStack.pop();
            const prev = appState.historyStack[appState.historyStack.length - 1];

            if (!prev || prev === 'home' || prev === 'list') {
                DOM.headerTitle.innerText = "æ´»å‹•èˆ‡å ±å";
                switchView('view-home');
                appState.historyStack = ['home'];
                appState.currentEvent = null;
                renderEventGrid(appState.currentCategory);
            }
        }

        function toggleHistoryView() {
            const container = document.getElementById('history-list');
            const isHidden = container.classList.contains('hidden');
            const btnText = document.getElementById('history-btn-text');
            // ä¿®æ­£ï¼šæ”¹ç‚ºæ§åˆ¶æ´»å‹•åˆ—è¡¨å€å¡Šè€Œéå·²åˆªé™¤çš„ active-categories
            const activeEventSection = document.getElementById('active-event-section');
            const createBtn = document.getElementById('btn-create-event');

            if (isHidden) {
                // åˆ‡æ›åˆ°æ­·å²æ¨¡å¼
                if (activeEventSection) activeEventSection.classList.add('hidden');
                if (createBtn) createBtn.classList.add('hidden');
                container.classList.remove('hidden');
                btnText.innerText = "è¿”å›é¦–é ";

                // æ¸²æŸ“æ­·å²åˆ—è¡¨
                const list = document.getElementById('history-items');
                list.innerHTML = '';
                // ç¯©é¸å·²çµæŸçš„æ´»å‹• (isActive !== 'open')
                const history = appState.events.filter(e => !isEventOpen(e));

                if (history.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">ç„¡æ­·å²ç´€éŒ„</div>';
                } else {
                    // æ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨ DocumentFragment å–ä»£ innerHTML ç´¯åŠ 
                    const fragment = document.createDocumentFragment();
                    history.forEach(e => {
                        const div = document.createElement('div');
                        div.className = "bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-50";
                        div.onclick = () => enterEventDetail(e.id);
                        div.innerHTML = `
                            <div>
                                <h4 class="font-bold text-gray-700">${e.name}</h4>
                                <div class="text-xs text-gray-400 mt-1">${formatDateShort(e.time)}</div>
                            </div>
                            <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full">å·²çµæŸ</span>`;
                        fragment.appendChild(div);
                    });
                    list.appendChild(fragment);
                }
            } else {
                // åˆ‡æ›å›é¦–é æ¨¡å¼
                if (activeEventSection) activeEventSection.classList.remove('hidden');
                if (createBtn) createBtn.classList.remove('hidden');
                container.classList.add('hidden');
                btnText.innerText = "æŸ¥çœ‹æ­·å²æ´»å‹•";
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('opacity-0', 'pointer-events-none', 'top-6');
            toast.classList.add('top-20', 'opacity-100');

            setTimeout(() => {
                toast.classList.remove('top-20', 'opacity-100');
                toast.classList.add('opacity-0', 'pointer-events-none', 'top-6');
            }, 2500);
        }

        function showConfirm(msg) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                document.getElementById('confirm-msg').innerHTML = msg;
                modal.classList.remove('hidden');

                const cleanup = () => {
                    modal.classList.add('hidden');
                    document.getElementById('confirm-yes').onclick = null;
                    document.getElementById('confirm-no').onclick = null;
                };

                document.getElementById('confirm-yes').onclick = () => { cleanup(); resolve(true); };
                document.getElementById('confirm-no').onclick = () => { cleanup(); resolve(false); };
            });
        }

        function closeDetailsModal() {
            const content = document.getElementById('modal-content');
            content.classList.remove('translate-y-10', 'sm:translate-y-0', 'opacity-100');
            content.classList.add('translate-y-full', 'opacity-0');
            setTimeout(() => document.getElementById('details-modal').classList.add('hidden'), 300);
        }

        // --- Sponsor Functions ---
        function renderAddSponsorUI() {
            const type = document.querySelector('input[name="addSponsorType"]:checked').value;
            const area = document.getElementById('sponsor-input-area');
            if (type === 'alcohol') {
                area.innerHTML = `
                    <input id="sp-qty" type="number" class="w-20 border border-gray-300 rounded px-2 py-1 text-sm" placeholder="æ•¸é‡" min="1">
                    <select id="sp-unit" class="border border-gray-300 rounded px-2 py-1 text-sm bg-white">
                        <option value="ç“¶">ç“¶</option>
                        <option value="ç®±">ç®±</option>
                    </select>`;
            } else if (type === 'money') {
                area.innerHTML = `<input id="sp-money" type="number" class="w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="é‡‘é¡ (100ç‚ºå–®ä½)" min="100" step="100">`;
            } else {
                area.innerHTML = `<input id="sp-other" type="text" class="w-full border border-gray-300 rounded px-2 py-1 text-sm" placeholder="è´ŠåŠ©å…§å®¹">`;
            }
        }

        function addSponsor() {
            const type = document.querySelector('input[name="addSponsorType"]:checked').value;
            let res = '';

            if (type === 'alcohol') {
                const qty = document.getElementById('sp-qty').value;
                const unit = document.getElementById('sp-unit').value;
                if (!qty || parseInt(qty) <= 0) return showToast("è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡");
                res = `é…’é¡: ${qty}${unit}`;
            } else if (type === 'money') {
                const val = document.getElementById('sp-money').value;
                const num = parseInt(val);
                if (!num || num <= 0) return showToast("é‡‘é¡ä¸èƒ½ç‚ºè² æ•¸æˆ–é›¶");
                if (num % 100 !== 0) return showToast("é‡‘é¡é ˆç‚º 100 çš„å€æ•¸");
                res = `ç´…åŒ…: ${num}å…ƒ`;
            } else {
                const val = document.getElementById('sp-other').value.trim();
                if (!val) return showToast("è«‹è¼¸å…¥å…§å®¹");
                res = `å…¶ä»–: ${val}`;
            }
            appState.sponsorList.push(res);
            renderSponsorList();
        }

        function removeSponsor(i) { appState.sponsorList.splice(i, 1); renderSponsorList(); }



        // --- Helpers for Select Population ---
        function populateSelect(id, items) {
            const el = document.getElementById(id);
            if (!el) return;
            const val = el.value; // Preserve value
            el.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
            if (items) items.forEach(i => {
                const v = i.includes('|') ? i.split('|')[0] : i; // Handle "Label|Url" format
                // Ensure text does not contain URL if it is Name|Url
                const text = i.includes('|') ? i.split('|')[0] : v;
                el.add(new Option(text, v));
            });
            el.value = val;
        }

        function populateRoomOptions(id, opts) {
            const el = document.getElementById(id);
            const currentVal = el.value; // Preserve value
            el.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
            if (!opts) return;

            opts.forEach(opt => {
                let name = opt;
                let limit = null;
                // Parse "Double:10"
                if (opt.includes(':')) {
                    const parts = opt.split(':');
                    name = parts[0];
                    limit = parts[1];
                }

                // Get Current Stats
                const current = (appState.currentStats.roomCounts && appState.currentStats.roomCounts[name]) || 0;

                let label = name;
                if (limit) {
                    label += ` (å·²è¨‚:${current}/${limit})`;
                } else {
                    label += ` (å·²è¨‚:${current})`;
                }
                el.add(new Option(label, name));
            });
            el.value = currentVal;
        }

        function populateCountOptions() {
            const f = document.getElementById('family-count');
            const g = document.getElementById('add-guest-count');

            // äººæ•¸(å«çœ·å±¬)ï¼šé¡¯ç¤º 1~10 äººï¼Œå€¼ç‚º 0~9 (æ‰£é™¤æœ¬äºº)
            // é è¨­ 1 äºº (å€¼ 0)
            f.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                f.add(new Option(`${i} äºº`, i - 1));
            }

            // ä¾†è³“äººæ•¸ï¼šé¡¯ç¤º 1~10 äººï¼Œå€¼ç‚º 1~10
            g.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                g.add(new Option(`${i} äºº`, i));
            }
        }
        // onLocationChange å·²ç§»é™¤ï¼šå¼•ç”¨çš„ 'new-location-select' å…ƒç´ ä¸å­˜åœ¨
        function updatePickupMap() {
            const val = document.getElementById('pickup-loc').value;
            const btn = document.getElementById('pickup-map-btn');
            // Enhanced check for "Name|Url" format
            const opt = appState.currentEvent.pickupOpts?.find(o => o.startsWith(val) || (o.includes('|') && o.split('|')[0] === val));

            if (opt && opt.includes('|')) {
                btn.classList.remove('hidden');
                btn.href = opt.split('|')[1];
            } else {
                btn.classList.add('hidden');
            }
        }
        function toggleCreateFields() {
            const type = document.getElementById('new-type').value;
            const isTravel = type === 'travel';
            document.getElementById('new-field-time-single').classList.toggle('hidden', isTravel);
            document.getElementById('new-field-time-range').classList.toggle('hidden', !isTravel);
            document.getElementById('new-field-itinerary').classList.toggle('hidden', !isTravel);
            document.getElementById('travel-notice')?.classList.toggle('hidden', !isTravel);
        }

        function renderItinerary(str, timeStr) {
            const container = document.getElementById('itinerary-accordion-content');
            if (!container) return;

            container.innerHTML = '';
            if (!str) return;

            // æº–å‚™æ—¥æœŸè¨ˆç®—
            let startDate = null;
            if (timeStr) {
                const startRaw = timeStr.includes('~') ? timeStr.split('~')[0] : timeStr;
                const d = new Date(startRaw);
                if (!isNaN(d.getTime())) {
                    startDate = d;
                }
            }

            // 1. è§£æèˆ‡åˆ†çµ„
            const rawParts = str.split(/;|ï¼›/);
            const groupedDays = new Map();

            let currentDayNum = 1;

            rawParts.forEach((part, index) => {
                if (!part.trim()) return;

                // åµæ¸¬ D1, Day 1 æ¨™ç±¤
                let dayNum = currentDayNum;
                const match = part.match(/^(D(\d+)|Day\s*(\d+)|ç¬¬\s*(\d+)\s*å¤©)(\s*[:ï¼š])?/i);

                if (match) {
                    const numStr = match[2] || match[3] || match[4];
                    if (numStr) {
                        dayNum = parseInt(numStr);
                        currentDayNum = dayNum;
                    }
                }

                if (!groupedDays.has(dayNum)) {
                    groupedDays.set(dayNum, { rawTexts: [] });
                }

                // æ¸…é™¤ D1: å‰ç¶´
                let cleanPart = part;
                if (match) {
                    cleanPart = part.substring(match[0].length).trim();
                }

                groupedDays.get(dayNum).rawTexts.push(cleanPart);
            });

            // å»ºç«‹æ‰‹é¢¨ç´å¤–æ¡†
            const wrapper = document.createElement('div');
            wrapper.className = "border border-gray-200 rounded-2xl overflow-hidden bg-white shadow-sm";

            // 2. æ¸²æŸ“ HTML
            const sortedDayNums = Array.from(groupedDays.keys()).sort((a, b) => a - b);

            sortedDayNums.forEach((dayNum, idx) => {
                const group = groupedDays.get(dayNum);

                // è¨ˆç®—æ—¥æœŸæ¨™ç±¤ (é¡¯ç¤ºåœ¨ç¶ è‰²å°æ¡†æ¡†)
                let dayLabel = `D${dayNum}`; // é è¨­é¡¯ç¤º D1, D2
                if (startDate) {
                    const currentDay = new Date(startDate);
                    currentDay.setDate(startDate.getDate() + (dayNum - 1));
                    const m = currentDay.getMonth() + 1;
                    const d = currentDay.getDate();
                    const w = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][currentDay.getDay()];
                    dayLabel = `${m}/${d} (${w})`;
                }

                // â˜… ä¿®æ”¹é»ï¼šä¸»æ¨™é¡Œç›´æ¥è¨­å®šç‚º "ç¬¬ X å¤©è¡Œç¨‹"
                const accordionMainTitle = `ç¬¬ ${dayNum} å¤©è¡Œç¨‹`;

                let allContentHtml = '<div class="space-y-4 relative pl-2 pt-2 pb-2">';
                allContentHtml += '<div class="absolute left-[5px] top-4 bottom-2 w-0.5 bg-gray-100"></div>';

                group.rawTexts.forEach(text => {
                    if (!text.trim()) return;

                    // --- è³‡æ–™è§£æå€å¡Š ---
                    let itemTitle = text;
                    let itemDesc = '';
                    let itemUrl = '';

                    // 1. å¦‚æœæœ‰ç”¨ | åˆ†éš”ï¼Œå…ˆåˆ‡é–‹
                    if (text.includes('|')) {
                        const parts = text.split('|');
                        itemTitle = parts[0].trim();
                        itemDesc = parts.slice(1).join('|').trim();

                        // æª¢æŸ¥æœ€å¾Œä¸€å€‹æ¬„ä½æ˜¯å¦ç‚º URL
                        if (parts.length >= 3) {
                            const lastPart = parts[parts.length - 1].trim();
                            if (lastPart.startsWith('http')) {
                                itemUrl = lastPart;
                                itemDesc = parts.slice(1, parts.length - 1).join('|').trim();
                            }
                        }
                    }

                    // 2. æ™ºæ…§æå– URL
                    const urlRegex = /([ï¼ˆ\(ã€\[\{])?(https?:\/\/[^\s\)]+)([ï¼‰\)ã€‘\]\}])?/;
                    if (!itemUrl && itemDesc && urlRegex.test(itemDesc)) {
                        const match = itemDesc.match(urlRegex);
                        itemUrl = match[2];
                        itemDesc = itemDesc.replace(match[0], '').trim();
                    }
                    if (!itemUrl && itemTitle && urlRegex.test(itemTitle)) {
                        const match = itemTitle.match(urlRegex);
                        itemUrl = match[2];
                        itemTitle = itemTitle.replace(match[0], '').trim();
                    }

                    // 3. æ¸…ç†æ®˜ç•™ç¬¦è™Ÿ
                    itemTitle = itemTitle.replace(/^[ï¼š:\s]+/, '').replace(/\(\s*\)$/, '').trim();

                    // 4. è™•ç†æ¨™é¡Œå…§çš„æ—¥æœŸ
                    itemTitle = itemTitle.replace(/\d{4}[-/](\d{1,2})[-/](\d{1,2})/, '$1/$2').replace(/\b0(\d):\b/g, '$1:');

                    // 5. æå–æ™‚é–“ (HH:mm)
                    let timeDisplay = '';
                    const timeMatch = itemTitle.match(/(?:[\d\/\-\.]+\s+)?(\d{1,2}:\d{2})(?::\d{2})?\s*(.*)/);
                    if (timeMatch) {
                        let rawTime = timeMatch[1];
                        if (rawTime.startsWith('0')) rawTime = rawTime.substring(1);
                        timeDisplay = rawTime;
                        itemTitle = timeMatch[2].replace(/^[ï¼š:\s]+/, '');
                    }

                    // --- HTML ç”Ÿæˆå€å¡Š ---
                    const mapIconHtml = itemUrl ?
                        `<a href="${itemUrl}" target="_blank" class="inline-flex items-center justify-center w-6 h-6 bg-blue-50 text-blue-500 rounded-full hover:bg-blue-100 transition ml-2 shrink-0 self-center" title="å°èˆª" onclick="event.stopPropagation()">
                            <i data-lucide="map-pin" class="w-3.5 h-3.5"></i>
                         </a>` : '';

                    if (timeDisplay) {
                        allContentHtml += `
                            <div class="relative flex gap-3 items-start pl-4 group/item">
                                <div class="absolute left-0 top-1.5 w-3 h-3 bg-white border-[3px] border-green-500 rounded-full z-10 shadow-sm"></div>
                                <div class="font-mono font-bold text-green-700 shrink-0 pt-0.5 w-[42px] text-right mr-1">${timeDisplay}</div>
                                <div class="flex-1 min-w-0 pt-0.5">
                                    <div class="flex items-center flex-wrap">
                                        <span class="text-gray-800 font-bold leading-tight">${itemTitle}</span>
                                        ${mapIconHtml}
                                    </div>
                                    ${itemDesc ? `<p class="text-xs text-gray-500 mt-1 leading-relaxed">${itemDesc}</p>` : ''}
                                </div>
                            </div>`;
                    } else {
                        allContentHtml += `
                            <div class="relative flex gap-3 items-start pl-4">
                                <div class="absolute left-1 top-2.5 w-1.5 h-1.5 bg-gray-300 rounded-full z-10"></div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center flex-wrap">
                                        <span class="text-gray-700 font-medium leading-tight">${itemTitle}</span>
                                        ${mapIconHtml}
                                    </div>
                                    ${itemDesc ? `<p class="text-xs text-gray-500 mt-1 leading-relaxed">${itemDesc}</p>` : ''}
                                </div>
                            </div>`;
                    }
                });
                allContentHtml += '</div>';

                // æ‰‹é¢¨ç´ Header
                const isOpen = idx === 0;

                const details = document.createElement('details');
                details.setAttribute('name', 'itinerary-group');
                details.className = "group border-b border-gray-100 last:border-0 transition-all itinerary-group";
                if (isOpen) details.setAttribute('open', '');

                const summary = document.createElement('summary');
                summary.className = "flex justify-between items-center p-4 cursor-pointer select-none bg-white hover:bg-gray-50 transition list-none relative";

                summary.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <span class="bg-green-100 text-green-700 text-xs font-bold px-2.5 py-1 rounded-lg shrink-0 whitespace-nowrap">${dayLabel}</span>
                        <span class="font-bold text-gray-800 text-base truncate">${accordionMainTitle}</span>
                    </div>
                    <div class="w-6 h-6 flex items-center justify-center rounded-full border border-gray-200 bg-gray-50 text-gray-400 font-bold shrink-0 ml-2">
                        <span class="icon-plus">+</span>
                        <span class="icon-minus">âˆ’</span>
                    </div>
                `;

                const contentDiv = document.createElement('div');
                contentDiv.className = "px-4 pb-4 pt-0 bg-white text-sm text-gray-600 leading-relaxed space-y-2 group-content";
                contentDiv.innerHTML = allContentHtml;

                details.appendChild(summary);
                details.appendChild(contentDiv);
                wrapper.appendChild(details);
            });

            container.appendChild(wrapper);

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // --- åˆ†é¡åˆ‡æ›å‡½å¼ ---
        function switchCategory(type) {
            appState.currentCategory = type;
            // ç§»é™¤æ‰€æœ‰ Tab çš„ active æ¨£å¼
            document.querySelectorAll('.filter-tab').forEach(btn => btn.classList.remove('active'));
            // åŠ ä¸Šç•¶å‰ Tab çš„ active æ¨£å¼
            const tab = document.getElementById(`tab-${type}`);
            if (tab) tab.classList.add('active');

            renderEventGrid(type);
        }

        function showCreateView() {
            appState.historyStack.push('create');
            switchView('view-create');
            DOM.headerTitle.innerText = "å»ºç«‹æ–°æ´»å‹•";

            document.getElementById('new-name').value = '';
            document.getElementById('new-time-single').value = '';
            const dateStart = document.getElementById('new-date-start');
            const dateEnd = document.getElementById('new-date-end');
            if (dateStart) dateStart.value = '';
            if (dateEnd) dateEnd.value = '';

            document.getElementById('new-location').value = '';
            document.getElementById('new-address').value = '';
            document.getElementById('new-deadline').value = '';
            document.getElementById('new-itinerary').value = '';
            document.getElementById('new-organizer').value = appState.user.displayName;

            toggleCreateFields();
        }

        // --- Create Event (Real Submit) ---
        async function handleCreateEvent(e) {
            e.preventDefault();
            const btn = document.getElementById('create-btn');
            const originalBtnHTML = btn.innerHTML; // ä¿å­˜åŸå§‹æŒ‰éˆ•å…§å®¹

            // 1. é–å®šæŒ‰éˆ•é¿å…é‡è¤‡é»æ“Š
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> å»ºç«‹ä¸­...';
            refreshIcons();

            // 2. æ”¶é›†è¡¨å–®è³‡æ–™
            const type = document.getElementById('new-type').value;
            let timeVal = '';

            // æ ¹æ“šé¡å‹è™•ç†æ™‚é–“æ ¼å¼
            if (type === 'travel') {
                const start = document.getElementById('new-date-start').value;
                const end = document.getElementById('new-date-end').value;
                if (!start || !end) {
                    showToast("æ—…éŠæ´»å‹•è«‹å¡«å¯«å‡ºç™¼èˆ‡å›ç¨‹æ—¥æœŸ");
                    btn.disabled = false; btn.innerHTML = originalBtnHTML; return;
                }
                timeVal = `${start}~${end}`;
            } else {
                timeVal = document.getElementById('new-time-single').value;
                if (!timeVal) {
                    showToast("è«‹å¡«å¯«æ´»å‹•æ™‚é–“");
                    btn.disabled = false; btn.innerHTML = originalBtnHTML; return;
                }
            }

            // 3. æº–å‚™å‚³é€çš„è³‡æ–™ç‰©ä»¶
            const payload = {
                action: 'createEvent', // å‘Šè¨´ GAS é€™æ˜¯ã€Œå»ºç«‹æ´»å‹•ã€çš„è«‹æ±‚
                userId: appState.user.userId, // è¨˜éŒ„æ˜¯èª°å»ºç«‹çš„
                type: type,
                name: document.getElementById('new-name').value,
                organizer: document.getElementById('new-organizer').value,
                location: document.getElementById('new-location').value,
                address: document.getElementById('new-address').value,
                deadline: document.getElementById('new-deadline').value,
                time: timeVal,
                itinerary: document.getElementById('new-itinerary').value // æ—…éŠè¡Œç¨‹
            };

            try {
                // 4. ç™¼é€è‡³å¾Œç«¯
                await apiSubmit(payload);

                showToast("æ´»å‹•å»ºç«‹æˆåŠŸï¼");

                // 5. é‡æ–°è®€å–æ´»å‹•åˆ—è¡¨ä¸¦å›åˆ°é¦–é 
                await fetchEvents();
                appState.historyStack = ['home'];
                handleBackNav();

            } catch (err) {
                console.error(err);
                showToast("å»ºç«‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦");
            } finally {
                // 6. å¾©åŸæŒ‰éˆ•ç‹€æ…‹
                btn.disabled = false;
                btn.innerHTML = originalBtnHTML;
                refreshIcons();
            }
        }

        // --- Status Toggle (ä¿®å¾©ç‰ˆï¼šçœŸæ­£å‚³é€è³‡æ–™çµ¦ GAS) ---
        async function toggleEventStatus() {
            const btn = document.getElementById('btn-status-toggle');
            const originalHTML = btn.innerHTML; // è¨˜ä½åŸæœ¬æŒ‰éˆ•é•·æ€æ¨£

            // 1. é¡¯ç¤ºè®€å–å‹•ç•«
            btn.disabled = true;
            btn.innerHTML = '<i class="animate-spin" data-lucide="loader-2"></i> è™•ç†ä¸­';
            refreshIcons();

            // 2. åˆ¤æ–·ç›®å‰ç‹€æ…‹ä¸¦æ±ºå®šæ–°ç‹€æ…‹
            // ç›®å‰æ˜¯é–‹æ”¾ -> è¦æ”¹æˆ close
            // ç›®å‰æ˜¯é—œé–‰ -> è¦æ”¹æˆ open
            const currentStatus = isEventOpen(appState.currentEvent);
            const newStatus = currentStatus ? "close" : "open";

            try {
                // 3. ç™¼é€è«‹æ±‚çµ¦ GAS
                await apiSubmit({
                    action: 'toggleStatus',
                    eventId: appState.currentEvent.id,
                    userId: appState.user.userId, // ç”¨æ–¼é©—è­‰æ˜¯å¦ç‚ºä¸»è¾¦äºº
                    status: newStatus
                });

                // 4. æ›´æ–°æœ¬åœ°è³‡æ–™èˆ‡ç•«é¢
                appState.currentEvent.isActive = newStatus;
                renderEventStaticInfo();
                showToast(newStatus === "open" ? "æ´»å‹•å·²é‡æ–°é–‹æ”¾" : "æ´»å‹•å·²é—œé–‰");

            } catch (err) {
                console.error(err);
                showToast("ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            } finally {
                // 5. æ¢å¾©æŒ‰éˆ•
                btn.disabled = false;
                // renderEventStaticInfo æœƒè‡ªå‹•æ›´æ–°æŒ‰éˆ•æ–‡å­—ï¼Œæ‰€ä»¥é€™è£¡ä¸éœ€è¦é‚„åŸ originalHTML
            }
        }

        // Utils
        function isEventOpen(e) { return e.isActive === true || e.isActive === 'é–‹æ”¾' || e.isActive === 'open'; }
        function normalizeType(t) {
            t = t.toLowerCase();
            if (t.includes('ä¸€èˆ¬')) return 'general';
            if (t.includes('é¤æœƒ')) return 'banquet';
            if (t.includes('æ—…éŠ')) return 'travel';
            return t;
        }

        // --- Role Helper ---
        // â˜… æ–°å¢ï¼šçµ±ä¸€å–å¾—ç‰¹æ®Šèº«åˆ†å±¬æ€§ (æœƒé•·/è¼”å°æœƒé•·/çˆä¸»/å£½æ˜Ÿ)
        function getParticipantRoles(pName, event) {
            if (!pName) return [];
            const cleanName = pName.trim();
            const roles = [];
            const special = (appState.settings && appState.settings.specialRoles) ? appState.settings.specialRoles : {};

            if (special.president && cleanName === special.president) {
                roles.push({ type: 'president', label: 'ğŸ‘‘ æœƒé•·', textLabel: '[ğŸ‘‘æœƒé•·]', color: '#d97706' });
            }

            if (special.vicePresident && cleanName === special.vicePresident) {
                roles.push({ type: 'vicePresident', label: 'ğŸ‘¸ è¼”å°æœƒé•·', textLabel: '[ğŸ‘¸è¼”å°æœƒé•·]', color: '#9333ea' });
            }

            if (event && event.organizer) {
                const organizers = event.organizer.split(/[ã€,ï¼Œ\s]+/).map(o => o.trim()).filter(Boolean);
                if (organizers.includes(cleanName)) {
                    roles.push({ type: 'host', label: 'ğŸ» çˆä¸»', textLabel: '[ğŸ»çˆä¸»]', color: '#ea580c' });
                }
            }

            if (event && event.time) {
                let month = null;
                let timeStr = event.time;
                if (timeStr.includes('~')) timeStr = timeStr.split('~')[0];
                const d = new Date(timeStr);
                if (!isNaN(d.getTime())) {
                    month = d.getMonth() + 1;
                }

                if (month && special.birthdays && special.birthdays[month]) {
                    if (special.birthdays[month].includes(cleanName)) {
                        roles.push({ type: 'birthday', label: `ğŸ‚ ${month}æœˆå£½æ˜Ÿ`, textLabel: `[ğŸ‚${month}æœˆå£½æ˜Ÿ]`, color: '#db2777' });
                    }
                }
            }

            return roles;
        }

        // --- Share Modal Logic ---

        async function openShareModal() {
            const e = appState.currentEvent;
            const s = appState.currentStats;
            if (!e) return;

            // â˜… ä¿®æ­£ï¼šè‹¥ç„¡å¿«å–è³‡æ–™ï¼Œå…ˆå˜—è©¦æŠ“å–
            if (!appState.cachedDetails || appState.cachedDetails.length === 0) {
                // é¡¯ç¤ºè®€å–ä¸­ Toast
                showToast("æ­£åœ¨è®€å–åå–®...");
                const details = await fetchDetails();
                appState.cachedDetails = details;

                // è‹¥è®€å–å¾Œä»ç„¡è³‡æ–™ (æˆ–å¤±æ•—)ï¼Œæç¤ºä½¿ç”¨è€…
                if (!appState.cachedDetails || appState.cachedDetails.length === 0) {
                    // é›–ç„¶ç„¡åå–®ï¼Œä½†æ´»å‹•è³‡è¨Šä»å¯åˆ†äº«ï¼Œæ•…ä¸é˜»æ“‹ï¼Œåƒ…æç¤º
                    // showToast("ç›®å‰ç„¡å ±åè³‡æ–™");
                } else {
                    showToast("åå–®è®€å–å®Œæˆ");
                }
            }

            // é‡ç½® checkbox ç‹€æ…‹
            document.getElementById('share-opt-sponsor').checked = true;
            document.getElementById('share-opt-travel').checked = true;

            // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºã€Œè´ŠåŠ©/èªæ¡Œã€é¸é …
            const hasTable = s.tableCount && s.tableCount > 0;
            // é™¤äº†æª¢æŸ¥çµ±è¨ˆæ•¸æ“šï¼Œä¹Ÿå¾å¿«å–åå–®å¯¦éš›æª¢æŸ¥æ˜¯å¦æœ‰äººæœ‰è´ŠåŠ©è³‡æ–™
            const detailsHasSponsor = (appState.cachedDetails || []).some(p => {
                const tc = getIntField(p, 'tableCount');
                const spRaw = getField(p, 'sponsor');
                const spList = parseSponsorData(spRaw);
                return tc > 0 || spList.length > 0;
            });
            const hasSponsor = hasTable || detailsHasSponsor || (e.type !== 'travel' && s.secondary > 0);

            const sponsorEl = document.getElementById('opt-container-sponsor');
            if (hasSponsor) {
                sponsorEl.classList.remove('hidden');
            } else {
                sponsorEl.classList.add('hidden');
            }

            // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºã€Œä¸Šè»Š/æˆ¿å‹ã€é¸é …
            const isTravel = e.type === 'travel';
            const travelEl = document.getElementById('opt-container-travel');
            if (isTravel) {
                travelEl.classList.remove('hidden');
            } else {
                travelEl.classList.add('hidden');
            }

            // â˜… æ™ºæ…§åˆ¤æ–·ï¼šå¦‚æœæ²’ä»€éº¼å¥½é¸çš„ï¼Œç›´æ¥è¤‡è£½ä¸¦è·³éè¦–çª—
            const showSponsor = !sponsorEl.classList.contains('hidden');
            const showTravel = !travelEl.classList.contains('hidden');

            if (!showSponsor && !showTravel) {
                performCopy({ includeSponsor: false, includeTravel: false });
                return;
            }

            // ç¢ºä¿éš±è—ç„¡é¸é …æç¤º
            const noOptsEl = document.getElementById('share-no-opts');
            if (noOptsEl) noOptsEl.classList.add('hidden');

            // é‡ç½®é¸é …é è¨­ç‹€æ…‹ï¼ˆåƒ…å‹¾é¸è´ŠåŠ©/èªæ¡ŒåŠå ±åé€£çµï¼‰
            const mapCheckbox = document.getElementById('share-opt-map');
            const namesCheckbox = document.getElementById('share-opt-names');
            const linkCheckbox = document.getElementById('share-opt-link');
            if (mapCheckbox) mapCheckbox.checked = false;
            if (namesCheckbox) namesCheckbox.checked = false;
            if (linkCheckbox) linkCheckbox.checked = true;

            document.getElementById('share-modal').classList.remove('hidden');
            refreshIcons();
        }

        function confirmShareCopy() {
            // å–å¾—ä½¿ç”¨è€…å‹¾é¸ç‹€æ…‹
            const includeSponsor = document.getElementById('share-opt-sponsor').checked && !document.getElementById('opt-container-sponsor').classList.contains('hidden');
            const includeTravel = document.getElementById('share-opt-travel').checked && !document.getElementById('opt-container-travel').classList.contains('hidden');
            const includeMap = document.getElementById('share-opt-map').checked;
            const includeNames = document.getElementById('share-opt-names').checked;
            const includeLink = document.getElementById('share-opt-link').checked;

            // é—œé–‰è¦–çª—
            document.getElementById('share-modal').classList.add('hidden');

            // åŸ·è¡Œè¤‡è£½ï¼Œå‚³å…¥åƒæ•¸
            performCopy({ includeSponsor, includeTravel, includeMap, includeNames, includeLink });
        }

        // èˆŠæŒ‰éˆ• (åå–®è¦–çª—ä¸‹æ–¹) å‘¼å«æ­¤å‡½å¼ï¼šçµ±ä¸€å‘¼å« openShareModal ä»¥æä¾›é¸é …
        function copyDetailsToClipboard() {
            openShareModal();
        }

        // --- åœ–ç‰‡åˆ†äº«åŠŸèƒ½ ---
        async function shareAsImage() {
            const e = appState.currentEvent;
            if (!e) return;
            const data = appState.cachedDetails || [];

            const btn = document.getElementById('btn-share-image');
            const origHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ç”¢ç”Ÿä¸­...';
            refreshIcons();

            // åœ–ç‰‡åˆ†äº«ç‚ºå›ºå®šå…§å®¹ï¼Œä¸ä¾ç…§å‹¾é¸ï¼ˆåªæœ‰è¤‡è£½æ–‡å­—æ‰ä¾å‹¾é¸ï¼‰
            const includeSponsor = false; // åå–®å…§ä¸é¡¯ç¤ºè´ŠåŠ©ï¼Œæ”¹ç”±ä¸‹æ–¹ç¨ç«‹å€å¡Šé¡¯ç¤º
            const includeTravel = true;
            const includeMap = false;  // åœ–ç‰‡ä¸å«åœ°åœ–é€£çµ
            const includeNames = true;
            const includeLink = false; // åœ–ç‰‡ä¸å«å ±åé€£çµ

            try {
                // --- 1. å‹•æ…‹ç”¢ç”Ÿåˆ†äº«å¡ç‰‡ HTML ---
                const card = document.createElement('div');
                card.style.cssText = 'position:fixed;left:-9999px;top:0;width:420px;padding:32px;background:linear-gradient(180deg,#f0fdf4 0%,#ffffff 100%);font-family:"Segoe UI","Noto Sans TC",sans-serif;color:#1f2937;z-index:-1;';

                // æ´»å‹•æ¨™é¡Œå€
                let html = '';
                html += '<div style="background:linear-gradient(135deg,#06c755 0%,#059669 100%);color:white;padding:20px 24px;border-radius:16px;margin-bottom:20px;">';
                html += `<div style="font-size:22px;font-weight:800;">ğŸ“… ${e.name}</div>`;
                html += '</div>';

                // æ´»å‹•è³‡è¨Šå€
                html += '<div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:16px 20px;margin-bottom:16px;">';
                if (e.organizer) html += `<div style="font-size:14px;margin-bottom:8px;">ğŸ‘¤ ä¸»è¾¦äººï¼š${e.organizer}</div>`;
                let timeDisplay = e.time;
                if (timeDisplay) {
                    const d = new Date(timeDisplay);
                    if (!isNaN(d.getTime())) {
                        const week = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][d.getDay()];
                        timeDisplay = `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')} (${week}) ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
                    }
                }
                if (timeDisplay) html += `<div style="font-size:14px;margin-bottom:8px;">ğŸ•’ æ™‚é–“ï¼š${timeDisplay}</div>`;
                if (e.location) html += `<div style="font-size:14px;margin-bottom:8px;">ğŸ“ åœ°é»ï¼š${e.location}</div>`;
                if (e.address) html += `<div style="font-size:14px;margin-bottom:8px;">ğŸš— åœ°å€ï¼š${e.address}</div>`;
                if (includeMap) {
                    const mapQuery = e.address || e.location;
                    html += `<div style="font-size:13px;margin-bottom:4px;color:#2563eb;">ğŸ—ºï¸ åœ°åœ–ï¼šhttps://www.google.com/maps/search/${encodeURIComponent(mapQuery)}</div>`;
                }
                if (includeLink) {
                    html += `<div style="font-size:13px;color:#2563eb;">ğŸ”— å ±åï¼šhttps://liff.line.me/${LIFF_ID}</div>`;
                }
                html += '</div>';

                // åå–®å€
                if (includeNames && data.length > 0) {
                    html += '<div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:16px 20px;margin-bottom:16px;">';
                    html += '<div style="font-size:15px;font-weight:700;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #06c755;">ğŸ‘¥ å ±ååå–®</div>';
                    let count = 0;
                    data.forEach(p => {
                        count++;
                        const family = getIntField(p, 'family');
                        const guestData = parseGuestData(p);
                        const guestCountFallback = getIntField(p, 'guestCount');
                        const guestTotalCount = guestData.reduce((acc, g) => acc + g.count, 0);
                        const finalGuestCount = guestTotalCount > 0 ? guestTotalCount : guestCountFallback;
                        const total = 1 + family + finalGuestCount;
                        const num = count.toString().padStart(2, '0');
                        const status = p.status || p.note || '';
                        let prefix = status ? status : '';

                        // â˜… æ–°å¢ï¼šå–å¾—è§’è‰²æ¨™ç±¤ä¸¦è½‰æ›ç‚º HTML
                        const roles = getParticipantRoles(p.name, e);
                        let tagHtml = '';
                        if (roles.length > 0) {
                            // æ”¹ç‚ºç´”æ–‡å­—é¡è‰²è®ŠåŒ–ï¼Œä¸ä½¿ç”¨èƒŒæ¿è‰²å¡Š
                            tagHtml = roles.map(r => `<span style="color:${r.color};font-size:12px;font-weight:bold;margin-left:6px;display:inline-flex;align-items:center;">${r.label}</span>`).join('');
                        }

                        html += `<div style="font-size:14px;padding:4px 0;border-bottom:1px solid #f3f4f6;display:flex;align-items:center;">`;
                        html += `<span style="color:#06c755;font-weight:700;margin-right:4px;">${num}.</span> <span style="display:inline-flex;align-items:center;">${prefix}${p.name}${tagHtml}</span>`;
                        if (total > 1) html += `<span style="color:#f59e0b;font-weight:600;margin-left:6px;">Ã—${total}</span>`;
                        html += '</div>';

                        // ä¾†è³“
                        if (guestData.length > 0) {
                            const guestParts = guestData.map(g => g.count > 1 ? `${g.name}Ã—${g.count}` : g.name);
                            html += `<div style="font-size:12px;color:#6b7280;padding:2px 0 4px 20px;">ä¾†è³“ï¼š${guestParts.join('ã€')}</div>`;
                        } else {
                            const guestNameStr = getField(p, 'guestName');
                            if (guestNameStr && guestNameStr !== 'ç„¡') {
                                html += `<div style="font-size:12px;color:#6b7280;padding:2px 0 4px 20px;">ä¾†è³“ï¼š${guestNameStr}</div>`;
                            }
                        }

                        // è´ŠåŠ©
                        if (includeSponsor) {
                            let moneyLines = [];
                            const tc = getIntField(p, 'tableCount');
                            if (tc > 0) moneyLines.push(`èªæ¡Œ: ${tc}æ¡Œ`);
                            const sponsorRaw = getField(p, 'sponsor');
                            const sponsorList = parseSponsorData(sponsorRaw);
                            sponsorList.forEach(s => moneyLines.push(`è´ŠåŠ©: ${s}`));
                            if (moneyLines.length > 0) {
                                html += `<div style="font-size:12px;color:#d97706;padding:2px 0 4px 20px;">${moneyLines.join('ã€')}</div>`;
                            }
                        }

                        // ä¸Šè»Š/æˆ¿å‹
                        if (includeTravel) {
                            let travelLines = [];
                            if (p.pickup && p.pickup !== 'ç„¡') travelLines.push(`è»Š: ${p.pickup}`);
                            if (p.room && p.room !== 'ç„¡') travelLines.push(`æˆ¿: ${p.room}`);
                            if (guestData.length > 0) {
                                guestData.forEach(g => {
                                    let extras = [];
                                    if (g.pickup && g.pickup !== 'ç„¡') extras.push(g.pickup);
                                    if (g.room && g.room !== 'ç„¡') extras.push(g.room);
                                    if (extras.length > 0) travelLines.push(`[è³“]${g.name}: ${extras.join('/')}`);
                                });
                            }
                            if (travelLines.length > 0) {
                                html += `<div style="font-size:12px;color:#7c3aed;padding:2px 0 4px 20px;">${travelLines.join('ã€')}</div>`;
                            }
                        }
                    });
                    html += '</div>';
                }

                // è´ŠåŠ©/èªæ¡Œå½™ç¸½å€ï¼ˆç¨ç«‹å€å¡Šï¼Œä¸è«–æ˜¯å¦å‹¾é¸åå–®éƒ½æœƒé¡¯ç¤ºï¼‰
                if (data.length > 0) {
                    let sponsorHtml = '';
                    data.forEach(p => {
                        let moneyParts = [];
                        const tc = getIntField(p, 'tableCount');
                        if (tc > 0) moneyParts.push(`èªæ¡Œ: ${tc}æ¡Œ`);
                        const sponsorRaw = getField(p, 'sponsor');
                        const sponsorList = parseSponsorData(sponsorRaw);
                        sponsorList.forEach(s => moneyParts.push(`è´ŠåŠ©: ${s}`));
                        if (moneyParts.length > 0) {
                            sponsorHtml += `<div style="font-size:13px;padding:4px 0;border-bottom:1px solid #f3f4f6;"><span style="font-weight:600;">${p.name}</span>ï¼š${moneyParts.join('ã€')}</div>`;
                        }
                    });
                    if (sponsorHtml) {
                        html += '<div style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:16px 20px;margin-bottom:16px;">';
                        html += '<div style="font-size:15px;font-weight:700;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #f59e0b;color:#d97706;">ğŸ’° è´ŠåŠ© / èªæ¡Œè³‡è¨Š</div>';
                        html += sponsorHtml;
                        html += '</div>';
                    }
                }

                // çµ±è¨ˆå€
                html += '<div style="text-align:center;font-size:14px;font-weight:700;color:#374151;padding:8px 0;">';
                html += `å…± ${appState.currentStats.totalPeople || 0} äººå ±å`;
                html += '</div>';

                // æµ®æ°´å°
                html += '<div style="text-align:center;font-size:11px;color:#9ca3af;margin-top:8px;">å¤§è€äºŒå…„å¼Ÿæœƒ æ´»å‹•å ±åç³»çµ±</div>';

                card.innerHTML = html;
                document.body.appendChild(card);

                // --- 2. ä½¿ç”¨ html2canvas æˆªå–å¡ç‰‡ ---
                const canvas = await html2canvas(card, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: null,
                    width: card.scrollWidth,
                    height: card.scrollHeight
                });

                // ç§»é™¤æš«æ™‚å¡ç‰‡
                document.body.removeChild(card);

                // --- 3. è½‰ç‚º blob ä¸¦åˆ†äº«æˆ–ä¸‹è¼‰ ---
                canvas.toBlob(async (blob) => {
                    if (!blob) { showToast('åœ–ç‰‡ç”¢ç”Ÿå¤±æ•—'); return; }
                    const file = new File([blob], `${e.name}_åå–®.png`, { type: 'image/png' });

                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                    if (isMobile && navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            let shareText = `ğŸ“… ${e.name}\n`;
                            if (e.organizer) shareText += `ğŸ‘¤ ä¸»è¾¦äººï¼š${e.organizer}\n`;
                            let timeDisplay = e.time;
                            if (timeDisplay) {
                                const d = new Date(timeDisplay);
                                if (!isNaN(d.getTime())) {
                                    const week = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][d.getDay()];
                                    timeDisplay = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}(${week}) ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
                                }
                            }
                            if (timeDisplay) shareText += `ğŸ•’ æ™‚é–“ï¼š${timeDisplay}\n`;
                            if (e.location) shareText += `ğŸ“ åœ°é»ï¼š${e.location}\n`;
                            if (e.address) shareText += `ğŸš— åœ°å€ï¼š${e.address}\n`;
                            shareText += `---------------------\n`;
                            shareText += `å…± ${appState.currentStats.totalPeople || 0} äººå ±å\n`;
                            shareText += `ğŸ”— å ±åé€£çµğŸ‘‡ï¼š\nhttps://liff.line.me/${LIFF_ID}`;

                            await navigator.share({
                                files: [file],
                                title: e.name,
                                text: shareText
                            });
                            showToast('åœ–ç‰‡åˆ†äº«æˆåŠŸï¼');
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                console.error('åœ–ç‰‡åˆ†äº«å¤±æ•—:', err);
                                fallbackDownloadImage(canvas, e.name);
                            }
                        }
                    } else {
                        fallbackDownloadImage(canvas, e.name);
                    }

                    document.getElementById('share-modal').classList.add('hidden');
                }, 'image/png');

            } catch (err) {
                console.error('åœ–ç‰‡ç”¢ç”Ÿå¤±æ•—', err);
                showToast('ç”¢ç”Ÿåœ–ç‰‡å¤±æ•—ï¼š' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = origHtml;
                refreshIcons();
            }
        }

        function fallbackDownloadImage(canvas, evtName) {
            const link = document.createElement('a');
            link.download = `${evtName || 'æ´»å‹•'}_åå–®.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('å·²ä¸‹è¼‰åå–®åœ–ç‰‡ï¼');
        }

        // --- Telegram ç™¼é€åŠŸèƒ½ ---
        async function sendToTelegram() {
            if (!appState.currentEvent) return;

            showToast("æ­£åœ¨ç™¼é€è‡³ Telegram...");

            try {
                const result = await apiSubmit({
                    action: 'sendListToTelegram',
                    eventId: appState.currentEvent.id
                });

                if (result.success) {
                    showToast("âœ… åå–®å·²ç™¼é€è‡³ Telegram");
                } else {
                    showToast("âŒ ç™¼é€å¤±æ•—: " + (result.error || "æœªçŸ¥éŒ¯èª¤"));
                }
            } catch (err) {
                console.error(err);
                showToast("âŒ ç™¼é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            }
        }

        // æ ¸å¿ƒè¤‡è£½é‚è¼¯ï¼šæ”¯æ´åƒæ•¸èˆ‡æ ¼å¼åŒ–
        function performCopy(options = { includeSponsor: true, includeTravel: true, includeMap: true, includeNames: true, includeLink: true }) {
            // â˜… ä¿®æ”¹ç‚ºåŒæ­¥è®€å–å¿«å–è³‡æ–™
            const data = appState.cachedDetails || [];

            if (!data || data.length === 0) {
                // Try to fetch if cache is empty (though unlikely if modal is open)
                // But fetching async here will break mobile copy. 
                // So we just warn.
                return showToast("è³‡æ–™è®€å–ä¸­æˆ–ç„¡è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦");
            }

            // Sync execution continues...
            { // Block to keep variable scope clean equivalent to previous .then callback

                const e = appState.currentEvent;

                let text = `ğŸ“… ${e.name}\n`;
                // åˆ¤æ–·ä¸¦åŠ å…¥æ´»å‹•è³‡è¨Š
                if (e.organizer) text += `ğŸ‘¤ ä¸»è¾¦äººï¼š${e.organizer}\n`;

                // æ™‚é–“è™•ç†ï¼šåŠ å…¥(æ˜ŸæœŸX)æ ¼å¼
                let timeDisplay = e.time;
                if (timeDisplay) {
                    const d = new Date(timeDisplay);
                    if (!isNaN(d.getTime())) {
                        const week = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][d.getDay()];
                        timeDisplay = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}(${week}) ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
                    }
                }
                if (timeDisplay) text += `ğŸ•’ æ™‚é–“ï¼š${timeDisplay}\n`;

                if (e.location) text += `ğŸ“ åœ°é»ï¼š${e.location}\n`;
                if (e.address) text += `ğŸš— åœ°å€ï¼š${e.address}\n`;
                text += `---------------------\n`;



                if (options.includeNames !== false) {
                    let count = 0;
                    data.forEach((p, i) => {
                        count++;
                        const family = getIntField(p, 'family');

                        const guestData = parseGuestData(p);
                        const guestCountFallback = getIntField(p, 'guestCount');

                        const guestTotalCount = guestData.reduce((acc, g) => acc + g.count, 0);
                        const finalGuestCount = guestTotalCount > 0 ? guestTotalCount : guestCountFallback;
                        const total = 1 + family + finalGuestCount;

                        const num = count.toString().padStart(2, '0');
                        const status = p.status || p.note || '';
                        const prefix = status ? status : '';

                        // â˜… æ–°å¢ï¼šç´”æ–‡å­—è¤‡è£½æ™‚é™„åŠ æ–‡å­—æ¨™ç±¤
                        const roles = getParticipantRoles(p.name, e);
                        let textTags = '';
                        if (roles.length > 0) {
                            textTags = ' ' + roles.map(r => r.textLabel).join('');
                        }

                        text += `${num}. ${prefix}${p.name}${textTags}`;
                        if (total > 1) text += ` *${total}`;
                        text += `\n`;

                        // â˜… ä¿®æ”¹ï¼šä¾†è³“åå–®æ•´åˆç‚ºå–®è¡Œï¼Œé¡¯ç¤ºåœ¨ä¸‹æ–¹ â˜…
                        if (guestData.length > 0) {
                            const guestParts = guestData.map(g => {
                                return g.count > 1 ? `${g.name}*${g.count}` : g.name;
                            });
                            text += `      ä¾†è³“ï¼š${guestParts.join('ã€')}\n`;
                        } else {
                            const guestNameStr = getField(p, 'guestName');
                            if (guestNameStr && guestNameStr !== 'ç„¡') {
                                text += `      ä¾†è³“ï¼š${guestNameStr}\n`;
                            }
                        }

                        // è´ŠåŠ©/èªæ¡Œä¸åœ¨åå–®å…§é¡¯ç¤ºï¼Œæ”¹ç”±ä¸‹æ–¹ç¨ç«‹å€å¡Šçµ±ä¸€åˆ—å‡º

                        if (options.includeTravel) {
                            let travelLines = [];
                            if (p.pickup && p.pickup !== 'ç„¡') travelLines.push(`[ä¸»]è»Š: ${p.pickup}`);
                            if (p.room && p.room !== 'ç„¡') travelLines.push(`[ä¸»]æˆ¿: ${p.room}`);

                            if (guestData.length > 0) {
                                guestData.forEach(g => {
                                    let extras = [];
                                    if (g.pickup && g.pickup !== 'ç„¡') extras.push(g.pickup);
                                    if (g.room && g.room !== 'ç„¡') extras.push(g.room);
                                    if (extras.length > 0) {
                                        travelLines.push(`[è³“]${g.name}: ${extras.join('/')}`);
                                    }
                                });
                            }
                            if (travelLines.length > 0) {
                                travelLines.forEach(l => text += `      ${l}\n`);
                            }
                        }
                    });
                }

                // â˜… è´ŠåŠ©/èªæ¡Œç¨ç«‹å€å¡Šï¼ˆä¸è«–æ˜¯å¦å‹¾é¸åå–®ï¼Œåªè¦æœ‰è³‡æ–™å°±é¡¯ç¤ºï¼‰
                if (options.includeSponsor) {
                    let hasSponsorData = false;
                    let sponsorText = '';
                    data.forEach(p => {
                        let moneyLines = [];
                        const tc = getIntField(p, 'tableCount');
                        if (tc > 0) moneyLines.push(`èªæ¡Œ: ${tc}æ¡Œ`);

                        const sponsorRaw = getField(p, 'sponsor');
                        const sponsorList = parseSponsorData(sponsorRaw);
                        sponsorList.forEach(s => moneyLines.push(`è´ŠåŠ©: ${s}`));

                        if (moneyLines.length > 0) {
                            hasSponsorData = true;
                            sponsorText += `${p.name}ï¼š${moneyLines.join('ã€')}\n`;
                        }
                    });
                    if (hasSponsorData) {
                        text += `ã€è´ŠåŠ©/èªæ¡Œã€‘\n${sponsorText}`;
                    }
                }

                text += `---------------------\n`;
                text += `å…± ${appState.currentStats.totalPeople || 0} äººå ±å\n`;

                if (options.includeMap && e.address) {
                    text += `ğŸ—ºï¸ Google åœ°åœ–ï¼š\nhttps://www.google.com/maps/search/?api=1&query=${e.address}\n`;
                }

                if (options.includeLink !== false) {
                    text += `ğŸ”— å ±åé€£çµğŸ‘‡ï¼š\nhttps://liff.line.me/${LIFF_ID}\n`;
                }

                copyTextToClipboard(text);
            }
        }

        // --- â˜…â˜…â˜… é€™è£¡å°±æ˜¯ä¿®æ­£çš„é—œéµï¼ŒåŸæœ¬éºå¤±çš„å‡½å¼ â˜…â˜…â˜… ---
        function formatDateShort(isoStr) {
            if (!isoStr) return '';

            // å¦‚æœæ˜¯æ—…éŠæ´»å‹•çš„æ™‚é–“ç¯„åœ (ä¾‹å¦‚: 2023-10-10~2023-10-12)
            if (isoStr.includes('~')) {
                const start = isoStr.split('~')[0];
                const d = new Date(start);
                // å¦‚æœæ—¥æœŸç„¡æ•ˆï¼Œå›å‚³åŸå§‹å­—ä¸²
                if (isNaN(d.getTime())) return start;
                return `${d.getMonth() + 1}/${d.getDate()}...`;
            }

            const d = new Date(isoStr);
            // å¦‚æœæ—¥æœŸç„¡æ•ˆï¼Œå›å‚³åŸå§‹å­—ä¸²
            if (isNaN(d.getTime())) return isoStr;

            const week = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][d.getDay()];
            // å›å‚³æ ¼å¼: æœˆ/æ—¥ (æ˜ŸæœŸ)
            return `${d.getMonth() + 1}/${d.getDate()} (${week})`;
        }

        function formatDate(isoStr) {
            if (!isoStr) return '';
            const d = new Date(isoStr);
            if (isNaN(d.getTime())) return isoStr;
            const week = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][d.getDay()];
            return `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')} (${week}) ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }

        function formatDateOnly(isoStr) {
            if (!isoStr) return '';
            const d = new Date(isoStr);
            if (isNaN(d.getTime())) return isoStr;
            const week = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][d.getDay()];
            return `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')} (${week})`;
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) { window.requestAnimationFrame(step); }
            };
            window.requestAnimationFrame(step);
        }

        function validateForm() {
            if (!DOM.userName || !DOM.userName.value.trim()) {
                showToast('è«‹å¡«å¯«å§“å');
                return false;
            }
            return true;
        }

        function addGuest() {
            const name = document.getElementById('add-guest-name').value.trim();
            const count = parseInt(document.getElementById('add-guest-count').value);
            if (!name) return showToast("è«‹è¼¸å…¥ä¾†è³“å§“å");

            const pickup = document.getElementById('add-guest-pickup').value;
            const room = document.getElementById('add-guest-room').value;

            // ç”¢ç”Ÿç°¡æ˜“æš«æ™‚ ID
            const id = 'g_' + Date.now() + Math.random().toString(36).substr(2, 5);

            appState.guestList.push({ id, name, count, pickup, room });
            document.getElementById('add-guest-name').value = '';
            renderGuestList();
        }
        function removeGuest(id) {
            appState.guestList = appState.guestList.filter(g => g.id !== id);
            renderGuestList();
        }

        function restoreSponsorList(str) {
            appState.sponsorList = parseSponsorData(str);
            renderSponsorList();
        }

        function ensureManualCopyModalExists() {
            if (document.getElementById('manual-copy-modal')) return;
            // å»ºç«‹è¦–çª—å®¹å™¨
            const div = document.createElement('div');
            // ç›´æ¥ä½¿ç”¨ insertAdjacentHTML æ’å…¥ body ä»¥é¿å…å¤–å±¤åŒ…è£å•é¡Œ
            const html = `
<div id="manual-copy-modal" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm hidden text-left" style="backdrop-filter: blur(4px);">
    <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl transform transition-all flex flex-col max-h-[80vh]">
        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 shrink-0">
            <h3 class="font-bold text-gray-800 flex items-center gap-2">
                <i data-lucide="clipboard-copy" class="w-5 h-5 text-gray-600"></i>
                è¤‡è£½åå–®
            </h3>
            <button onclick="document.getElementById('manual-copy-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-200 transition">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="p-5 space-y-4 overflow-y-auto flex-1">
            <div class="bg-blue-50 text-blue-700 p-3 rounded-lg text-sm flex items-start gap-2">
                <i data-lucide="info" class="w-4 h-4 mt-0.5 shrink-0"></i>
                <div class="leading-relaxed">è‹¥è‡ªå‹•è¤‡è£½å¤±æ•—ï¼Œè«‹é»é¸ã€Œé»æ“Šè¤‡è£½ã€æŒ‰éˆ•ï¼Œæˆ–é•·æŒ‰ä¸‹æ–¹æ–‡å­—æ¡†å…¨é¸è¤‡è£½ã€‚</div>
            </div>
            <!-- iOS ä¿®æ­£ï¼šç§»é™¤ readonlyï¼Œä½¿ç”¨ inputmode="none" èˆ‡ contenteditable -->
            <textarea id="manual-copy-area" 
                class="w-full h-48 border border-gray-200 rounded-xl p-3 text-sm font-mono bg-gray-50 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none resize-none text-gray-700" 
                inputmode="none"
                onclick="this.select(); this.setSelectionRange(0, 99999);"></textarea>
        </div>
        <div class="p-4 border-t border-gray-100 bg-gray-50 flex gap-3 shrink-0">
             <button onclick="document.getElementById('manual-copy-modal').classList.add('hidden')" class="flex-1 py-3 rounded-xl font-bold text-gray-500 bg-white border border-gray-200 hover:bg-gray-50 transition">é—œé–‰</button>
             <button onclick="retryCopy()" class="flex-1 py-3 rounded-xl font-bold text-white bg-[#06c755] hover:bg-green-600 shadow-md active:scale-95 transition flex justify-center items-center gap-2">
                <i data-lucide="copy" class="w-4 h-4"></i> é»æ“Šè¤‡è£½
             </button>
        </div>
    </div>
</div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            refreshIcons();
        }

        function retryCopy() {
            const area = document.getElementById('manual-copy-area');
            const text = area.value;
            // å„ªå…ˆå˜—è©¦éåŒæ­¥ APIï¼ˆç¾æ‡‰è™•æ–¼ä½¿ç”¨è€…æ“ä½œè§¸ç™¼ä¹‹æƒ…å¢ƒï¼‰
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast("å·²è¤‡è£½åå–®åˆ°å‰ªè²¼ç°¿");
                    document.getElementById('manual-copy-modal').classList.add('hidden');
                }).catch(err => {
                    console.error('Retry Async failed', err);
                    fallbackCopyManual();
                });
            } else {
                fallbackCopyManual();
            }
        }

        function fallbackCopyManual() {
            const area = document.getElementById('manual-copy-area');
            area.focus();
            area.select();
            // iOS ä¿®æ­£
            area.setSelectionRange(0, 99999);
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast("å·²è¤‡è£½åå–®åˆ°å‰ªè²¼ç°¿");
                    document.getElementById('manual-copy-modal').classList.add('hidden');
                } else {
                    showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é•·æŒ‰å…¨é¸è¤‡è£½");
                }
            } catch (e) {
                showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½");
            }
        }

        function copyTextToClipboard(text) {
            const manualFallback = () => openManualCopyModal(text);

            // 1. ç¬¬ä¸€å‚™æ¡ˆï¼šTextareaï¼ˆéƒ¨åˆ†æ‰‹æ©Ÿç€è¦½å™¨æ”¯æ´åŒæ­¥åŸ·è¡Œï¼‰
            const fallbackCopy = (txt) => {
                const textArea = document.createElement("textarea");
                textArea.value = txt;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px"; // é¿å…è¦–è¦ºé–ƒçˆ
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        if (navigator.vibrate) navigator.vibrate(50);
                        showToast("åå–®å·²è¤‡è£½ï¼");
                    } else {
                        throw new Error("execCommand failed");
                    }
                } catch (err) {
                    console.warn("Textarea fallback failed, opening manual modal", err);
                    manualFallback();
                }
                document.body.removeChild(textArea);
            };

            const directCopy = (txt) => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(txt).then(() => {
                        if (navigator.vibrate) navigator.vibrate(50);
                        showToast("åå–®å·²è¤‡è£½ï¼");
                    }).catch((err) => {
                        console.warn("Clipboard API failed", err);
                        fallbackCopy(txt);
                    });
                } else {
                    fallbackCopy(txt);
                }
            };

            const tryLiffOrCopy = () => {
                if (typeof liff !== 'undefined' && liff.isApiAvailable('shareTargetPicker')) {
                    liff.shareTargetPicker([{ type: "text", text: text }])
                        .then((res) => {
                            if (!res) directCopy(text);
                        })
                        .catch(() => directCopy(text));
                } else {
                    directCopy(text);
                }
            };

            // åˆ¤æ–·æ˜¯å¦ç‚ºæ‰‹æ©Ÿè£ç½®
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            // è‹¥ç‚ºæ‰‹æ©Ÿï¼Œå„ªå…ˆå˜—è©¦ä½¿ç”¨ç³»çµ±åŸç”Ÿåˆ†äº« API (æ”¯æ´å‚³é€è‡³ LINEã€MMS ç­‰)
            if (isMobile && navigator.share) {
                const e = appState.currentEvent;
                navigator.share({
                    title: e ? e.name : 'æ´»å‹•åˆ†äº«',
                    text: text
                }).then(() => {
                    console.log('åˆ†äº«æˆåŠŸ');
                }).catch((err) => {
                    // è‹¥ä½¿ç”¨è€…ä¸»å‹•å–æ¶ˆåˆ†äº«ï¼Œæœƒå›å‚³ AbortErrorï¼Œæ­¤æ™‚ä¸é ˆåŸ·è¡Œè¤‡è£½
                    if (err.name !== 'AbortError') {
                        console.warn("åŸç”Ÿåˆ†äº«ç™¼ç”ŸéŒ¯èª¤ï¼Œæ”¹ç‚ºè¤‡è£½æ–‡å­—", err);
                        tryLiffOrCopy();
                    }
                });
            } else {
                // é›»è…¦ç‰ˆæˆ–ä¸æ”¯æ´åŸç”Ÿåˆ†äº«çš„è£ç½®ï¼Œå‰‡å–®ç´”è¤‡è£½æ–‡å­—
                tryLiffOrCopy();
            }
        }

        // ç‚ºäº†ç¨‹å¼ç¢¼æ•´æ½”ï¼Œå°‡é–‹å•Ÿæ‰‹å‹•è¦–çª—çš„é‚è¼¯ç¨ç«‹å‡ºä¾† (è«‹å°‡æ­¤å‡½å¼åŠ åœ¨ copyTextToClipboard ä¸‹æ–¹)
        function openManualCopyModal(text) {
            ensureManualCopyModalExists();
            const area = document.getElementById('manual-copy-area');
            // ç¢ºä¿å…ƒç´ å­˜åœ¨å†è³¦å€¼
            if (area) {
                area.value = text;
                // é‡å° iOS Safari çš„ç‰¹æ®Šè™•ç†ï¼Œé˜²æ­¢éµç›¤å½ˆå‡ºä½†èƒ½é¸å–
                area.contentEditable = true;
                area.readOnly = false;
            }

            const modal = document.getElementById('manual-copy-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }

            refreshIcons();

            // å˜—è©¦é¸å–æ–‡å­—ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…ç›´æ¥è¤‡è£½
            if (area) {
                setTimeout(() => {
                    area.select();
                    area.setSelectionRange(0, 99999); // é‡å°è¡Œå‹•è£ç½®
                }, 100);
            }
        }
    </script>
</body>

</html>